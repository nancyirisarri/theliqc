var JS9;
if(JS9&&("object"!==typeof JS9||JS9.NAME))throw Error("Namespace 'JS9' already exists");
JS9={NAME:"JS9",VERSION:"1.1",COPYRIGHT:"Copyright (c) 2012-2014 Smithsonian Institution"};

JS9=function(a){a.DEFID="JS9";
a.WIDTH=728;//512
a.HEIGHT=728;//512
a.INFOWIDTH=345;
a.INFOHEIGHT=265;
a.MENUWIDTH=a.WIDTH;
a.MENUHEIGHT=50;
a.CONWIDTH=a.WIDTH;
a.CONHEIGHT=180;
a.PANWIDTH=Math.floor(a.WIDTH/1.6);
a.PANHEIGHT=Math.floor(a.HEIGHT/1.6);
a.MAGWIDTH=a.WIDTH/2;
a.MAGHEIGHT=a.HEIGHT/2;
a.DS9WIDTH=250;
a.DS9HEIGHT=250;
a.ANON="[anonymous]";
a.PREFSFILE="js9Prefs.json";
a.ZINDEX=0;
a.SHAPEZINDEX=4;
a.MESSZINDEX=8;
a.BTNZINDEX=8;
a.MENUZINDEX=1E3;
a.COLORSIZE=1024;
a.SCALESIZE=16384;
a.INSTALLDIR="";
a.TOROOT="";
a.PLUGINS="";
a.LIGHTWIN="dhtml";
a.ANTIALIAS=!1;
a.SCALEIREG=!0;
a.NOMOVE=3;
a.DBLCLICK=500;
a.TIMEOUT=250;
a.SUPERMENU=/^_SUPERMENU/;
var E=a,C=navigator.platform,F=navigator.appName,A=navigator.userAgent,B,t=A.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
B=A.match(/version\/([\.\d]+)/i);
t&&null!==B&&(t[2]=B[1]);
t=t?[t[1],t[2],C]:[F,navigator.appVersion,"-?",C];
t.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(A));
E.BROWSER=t;
a.globalOpts={helperType:"sock.io",helperPort:2718,winType:"light",rgb:{mode:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2png:!1,alerts:!0,internalValPos:!0,debug:0};
a.imageOpts={contrast:1,bias:0.5,invert:1,exp:1E3,colormap:"grey",scale:"squared",scaleclipping:"zscale",zscalecontrast:0.25,zscalesamples:600,zscaleline:120,wcssys:"physical",wcsunits:"pixels",lcs:"physical",valpos:!0,alpha1:100,alpha2:255,zoom:1,zooms:5,nancolor:"#000000",listonchange:!1};
a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",prependJS9Dir:!0,dataDir:null};
a.lightOpts={dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=230px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=542px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=10px,center=1,resize=1,scrolling=1"}};

a.textColorOpts={regions:"#00FF00",info:"#00FF00"};
a.plotOpts={zoomStack:!0,selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}}};
a.helpOpts={user:{type:"help",url:"user.html",title:"JS9 User Manual"},install:{type:"help",url:"install.html",title:"Installing JS9"},webpage:{type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{type:"help",url:"localtasks.html",title:"Local Analysis with JS9"},publicapi:{type:"help",url:"publicapi.html",title:"The JS9 Public API"},helper:{type:"help",url:"helper.html",title:"Adding Server-side Analysis"},serverside:{type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},extmsg:{type:"help",url:"extmsg.html",title:"JS9 External Messaging"},preferences:{type:"help",url:"preferences.html",title:"JS9 Site Preferences"},repfile:{type:"help",url:"repfile.html",title:"The PNG Represention File"},changelog:{type:"help",url:"changelog.html",title:"JS9 ChangeLog"},issues:{type:"help",url:"knownissues.html",title:"Known Issues"}};
a.menuButtonOptsArr=[{name:"file",label:"File"},{name:"view",label:"View"},{name:"zoom",label:"Zoom"},{name:"scale",label:"Scale"},{name:"color",label:"Color"},{name:"region",label:"Region"},{name:"wcs",label:"WCS"},{name:"analysis",label:"Analysis"},{name:"help",label:"Help"}];
a.images=[];
a.displays=[];
a.colormaps=[];
a.commands=[];
a.plugins=[];
a.preloads=[];
a.auxFiles=[];
a.publics={};
a.helper={};
a.scales="linear log pow sqrt squared asinh sinh".split(" ");

a.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");
a.wcsunitss=["degrees","sexagesimal","pixels"];
a.menubarHTML="";
a.consoleHTML="<form name='form' onsubmit='return false;' class='JS9CmdForm' action=''><table class='JS9CmdTable'><tr class='JS9Tr'><td><div id='JS9CmdPrompt' class='JS9CmdPrompt'>@@PR@@</div></td><td class='JS9CmdTd'><input type='text' class='JS9CmdIn' autocomplete='off' value='' /></td></tr></table></form>";
a.bugs={};
a.bugs.hide_menu=!0;
"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);
"Chrome"===a.BROWSER[0]&&(a.bugs.tval=parseInt(a.BROWSER[1].split(".").shift(),10),31<=a.bugs.tval&&33>=a.bugs.tval&&(a.bugs.chrome_31=!0));
a.Image=function(c,b,d){var e=[],f,g,h,j=this,l=null;
b&&("object"===typeof b?(l=b,l.display&&(f=l.display)):f=b);
f||(f=0<a.displays.length?a.displays[0].id:a.DEFID);
this.type="image";
this.display=a.lookupDisplay(f);
this.params=$.extend(!0,{},a.imageOpts,l);
this.cmapObj=a.lookupColormap(this.params.colormap);

this.displayMode=!0;
this.evstate=-1;
this.rclick=0;
this.queried=!1;
this.iy=this.ix=0;
this.helperCoords="";
this.params.scalemin=Number.Nan;
this.params.scalemax=Number.Nan;
this.params.xeqonchange=!0;
this.params.plotOpts=$.extend(!0,{},a.plotOpts);
this.png={};
this.png.image=new Image;
this.status={};
this.primary={};
this.primary.sect={zoom:1,ozoom:1};
this.layers={};
this.lcs={};
this.aux={};
this.binning={bin:1,obin:1};
this.updateshapes=!1;
void 0!==l.xcen&&e.push(l.xcen);
void 0!==l.ycen&&e.push(l.ycen);
void 0!==l.zoom&&e.push(l.zoom);
switch(typeof c){case "object":this.source="fits";
this.mkRawDataFromHDU(c,c.filename);
"zscale"===this.params.scaleclipping&&this.zscale(!0);
this.mkSection();
e.length&&this.mkSection.apply(this,e);
this.displayImage("all");
this.clearMessage();
a.images.push(this);
if(d)try{a.xeqByName(d,window,this)}catch(n){a.error("in image onload callback",n,!1)}for(g in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(g)&&(h=this.display.pluginInstances[g],c=h.plugin.opts,h.isActive("onimageload")))try{c.onimageload.call(h,this)}catch(m){h.errLog("onimageload",m)}this.updateshapes&&this.updateShapes("regions","all","update");
this.status.load="complete";
a.waiting(!1);
break;
case "string":this.source="fits2png";
this.imtab="image";
this.file=c;
this.oid=this.file.split("/").reverse()[0];
this.id=a.getImageID(this.oid,this.display.id);
this.status.load="loading";
a.waiting(!0);
$(this.png.image).on("load",function(){var b,c,f;
j.mkOffScreenCanvas();
j.mkRawDataFromPNG();
"zscale"===j.params.scaleclipping&&j.zscale(!0);
j.mkSection();
e.length&&j.mkSection.apply(j,e);
j.displayImage("all");
j.clearMessage();
a.images.push(j);
if(d)try{a.xeqByName(d,window,j)}catch(g){a.error("in image onload callback",g,!1)}for(b in j.display.pluginInstances)if(j.display.pluginInstances.hasOwnProperty(b)&&(c=j.display.pluginInstances[b],f=c.plugin.opts,c.isActive("onimageload")))try{f.onimageload.call(c,j)}catch(l){h.errLog("onimageload",l)}j.status.load="complete";
a.waiting(!1);
a.DEBUG&&a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",j.file,j.raw.width,j.raw.height,j.raw.dmin,j.raw.dmax)}).on("error",function(){a.waiting(!1);
j.status.load="error";
a.error("could not load image: "+j.id)});
this.png.image.src=c;
break;
default:a.log("unknown specification type for Load: "+typeof c)}};
a.Image.prototype.closeImage=function(){var c,b,d,e,f,g;
b=a.images.length;
var h=this.display;
for(c=0;
c<b;
c++)if(this===a.images[c]){b=a.images[c];
b.clearMessage();
b.display.context.clear();
for(e in b.display.pluginInstances)if(b.display.pluginInstances.hasOwnProperty(e)&&(f=b.display.pluginInstances[e],g=f.plugin.opts,f.isActive("onimageclose")))try{g.onimageclose.call(f,b)}catch(j){f.errLog("onimageclose",j)}for(d in b.layers)b.layers.hasOwnProperty(d)&&(b.layers[d].canvas.dispose(),b.layers[d]=null);
b.display.image=null;
switch(b.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;
break;
case "green":a.globalOpts.rgb.gim=null;
break;
case "blue":a.globalOpts.rgb.bim=null}b.primary=null;
b.offscreen=null;
b.raw=null;
b.colorData=null;
b.colorCells=null;
b.psColors=null;
a.images.splice(c,1);
break}for(c=0;c<a.images.length;c++)if(b=a.images[c],h===b.display){b.displayImage("display");
break}};
a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;
this.offscreen={};
this.offscreen.canvas=document.createElement("canvas");
this.offscreen.canvas.setAttribute("width",this.png.image.width);
this.offscreen.canvas.setAttribute("height",this.png.image.height);
this.offscreen.context=this.offscreen.canvas.getContext("2d");
a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.mozImageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1);
this.offscreen.context.drawImage(this.png.image,0,0,this.png.image.width,this.png.image.height,0,0,this.png.image.width,this.png.image.height);
try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(c){"Chrome"===a.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read JS9 data")}return this};
a.Image.prototype.initLCS=function(a){var b=[[0,0,0],[0,0,0],[0,0,0]],d=function(a){var b,c,d=0,j=0,l=[[0,0,0],[0,0,0],[0,0,0]],n=a[0][0]*a[1][1];
for(b=0;
3>b;
b++)for(c=0;
2>c;
c++)if(void 0===a[b][c]||isNaN(a[b][c]))return null;
0<=n?d+=n:j+=n;
n=-a[0][1]*a[1][0];
0<=n?d+=n:j+=n;
b=d+j;
if(0===b||1E-15>Math.abs(b/(d-j)))return null;
b=1/b;
l[0][0]=a[1][1]*b;
l[1][0]=-a[1][0]*b;
l[0][1]=-a[0][1]*b;
l[1][1]=a[0][0]*b;
l[2][0]=-(a[2][0]*l[0][0]+a[2][1]*l[1][0]);
l[2][1]=
-(a[2][0]*l[0][1]+a[2][1]*l[1][1]);
return l};
a&&(b[0][0]=a.LTM1_1||1,b[1][0]=a.LTM2_1||0,b[0][1]=a.LTM1_2||0,b[1][1]=a.LTM2_2||1,b[2][0]=a.LTV1||0,b[2][1]=a.LTV2||0,this.lcs.physical={forward:$.extend(!0,[],b),reverse:d(b)},this.lcs.physical.reverse||delete this.lcs.physical,b[0][0]=a.DTM1_1||1,b[1][0]=a.DTM2_1||0,b[0][1]=a.DTM1_2||0,b[1][1]=a.DTM2_2||1,b[2][0]=a.DTV1||0,b[2][1]=a.DTV2||0,this.lcs.detector={forward:$.extend(!0,[],b),reverse:d(b)},this.lcs.detector.reverse||delete this.lcs.detector,b[0][0]=a.ATM1_1||1,b[1][0]=a.ATM2_1||0,b[0][1]=a.ATM1_2||0,b[1][1]=a.ATM2_2||1,b[2][0]=a.ATV1||0,b[2][1]=a.ATV2||0,this.lcs.amplifier={forward:$.extend(!0,[],b),reverse:d(b)},this.lcs.amplifier.reverse||delete this.lcs.amplifier,this.lcs[this.params.lcs]||(this.params.lcs="image"))};
a.Image.prototype.mkRawDataFromIMG=function(a){var b,d,e,f,g,h;
if(a){b=a.height;
d=a.width;
e=a.data;
this.raw.data=new Float32Array(b*d);
for(g=a=0;
g<b;
g++)for(f=0;
f<d;
f++)h=0.299*e[a]+0.587*e[a+1]+0.114*e[a+2],this.raw.data[(b-g)*d+f]=h,a+=4;
this.raw.width=d;
this.raw.height=b;
this.raw.bitpix=-32;
this.raw.dmin=Number.MAX_VALUE;
this.raw.dmax=Number.MIN_VALUE;
for(a=0;
a<b*d;
a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);
isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);
isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);
this.source="png";
this.raw.header=null;
return this}};
a.Image.prototype.mkRawDataFromPNG=function(){var c,b,d,e,f,g,h,j,l;
g=[];
c=new ArrayBuffer(8);
var n=new Uint8Array(c),m=new DataView(c);
if(!this.offscreen.img)return this;
this.raw={};
f=this.offscreen.img.data;
for(b=c=0;
c<f.length&&0!==f[c];
c++)if(255!==f[c]&&(g[b]=String.fromCharCode(f[c]),b++),15===b&&'{"js9Protocol":'!==g.join("")){e=!0;
break}if(15>b||e)this.mkRawDataFromIMG(this.offscreen.img),this.offscreen.img=null;
else{e=g.join("");
2<a.DEBUG&&a.log("jsonHeader: %s",e);
try{this.raw.header=JSON.parse(e)}catch(q){a.error("can't read FITS header from PNG file: "+e,q)}e=c+1;
this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");
this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");
this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");
this.raw.header.js9Endian?(this.raw.endian=this.raw.header.js9Endian,l="little"===this.raw.endian?!0:!1):a.error("js9Endian missing from PNG-based FITS header");

this.object=this.raw.header.OBJECT;
this.raw.dmin=Number.MAX_VALUE;
this.raw.dmax=Number.MIN_VALUE;
g=this.raw.width*this.raw.height;
b=e%4;
switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g);
for(c=0;
c<g;
c++){switch(b){case 0:h=f[e];
e+=1;
b=1;
break;
case 1:h=f[e];
e+=1;
b=2;
break;
case 2:h=f[e];
e+=2;
b=0;
break;
case 3:h=f[e+1],e+=2,b=1}this.raw.data[c]=h;
isNaN(h)||(this.raw.dmin=Math.min(this.raw.dmin,h),this.raw.dmax=Math.max(this.raw.dmax,h))}break;
case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(g),j=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(g),j=DataView.prototype.getUint16);
for(c=0;
c<g;
c++){switch(b){case 0:n[0]=f[e];
n[1]=f[e+1];
h=j.call(m,0,l);
e+=2;
b=2;
break;
case 1:n[0]=f[e];
n[1]=f[e+1];
h=j.call(m,0,l);
e+=3;
b=0;
break;
case 2:n[0]=f[e];
n[1]=f[e+2];
h=j.call(m,0,l);
e+=3;
b=1;
break;
case 3:n[0]=f[e+1],n[1]=f[e+2],h=j.call(m,0,l),e+=3,b=2}this.raw.data[c]=h;
isNaN(h)||(this.raw.dmin=Math.min(this.raw.dmin,h),this.raw.dmax=Math.max(this.raw.dmax,h))}break;
case 32:case -32:32===
this.raw.bitpix?(this.raw.data=new Int32Array(g),j=DataView.prototype.getInt32):(this.raw.data=new Float32Array(g),j=DataView.prototype.getFloat32);
for(c=0;
c<g;
c++){switch(b){case 0:n[0]=f[e];
n[1]=f[e+1];
n[2]=f[e+2];
n[3]=f[e+4];
h=j.call(m,0,l);
e+=5;
b=1;
break;
case 1:n[0]=f[e];
n[1]=f[e+1];
n[2]=f[e+3];
n[3]=f[e+4];
h=j.call(m,0,l);
e+=5;
b=2;
break;
case 2:n[0]=f[e];
n[1]=f[e+2];
n[2]=f[e+3];
n[3]=f[e+4];
h=j.call(m,0,l);
e+=6;
b=0;
break;
case 3:n[0]=f[e+1],n[1]=f[e+2],n[2]=f[e+3],n[3]=f[e+5],h=j.call(m,0,l),e+=6,b=1}this.raw.data[c]=h;
isNaN(h)||(this.raw.dmin=Math.min(this.raw.dmin,h),this.raw.dmax=Math.max(this.raw.dmax,h))}break;
case -64:this.raw.data=new Float64Array(g);
for(c=0;
c<g;
c++){switch(b){case 0:case 4:n[0]=f[e];
n[1]=f[e+1];
n[2]=f[e+2];
n[3]=f[e+4];
n[4]=f[e+5];
n[5]=f[e+6];
n[6]=f[e+8];
n[7]=f[e+9];
h=m.getFloat64(0,l);
e+=10;
b=2;
break;
case 1:case 5:n[0]=f[e];
n[1]=f[e+1];
n[2]=f[e+3];
n[3]=f[e+4];
n[4]=f[e+5];
n[5]=f[e+7];
n[6]=f[e+8];
n[7]=f[e+9];
h=m.getFloat64(0,l);
e+=11;
b=0;
break;
case 2:case 6:n[0]=f[e];

n[1]=f[e+2];
n[2]=f[e+3];
n[3]=f[e+4];
n[4]=f[e+6];
n[5]=f[e+7];
n[6]=f[e+8];
n[7]=f[e+10];
h=m.getFloat64(0,l);
e+=11;
b=1;
break;
case 3:case 7:n[0]=f[e+1],n[1]=f[e+2],n[2]=f[e+3],n[3]=f[e+5],n[4]=f[e+6],n[5]=f[e+7],n[6]=f[e+9],n[7]=f[e+10],h=m.getFloat64(0,l),e+=11,b=2}this.raw.data[c]=h;
isNaN(h)||(this.raw.dmin=Math.min(this.raw.dmin,h),this.raw.dmax=Math.max(this.raw.dmax,h))}break;
default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);

isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);
this.offscreen.img=null;
if("image"===this.type){if(a.initwcs)try{d=a.raw2FITS(this.raw),this.wcs=a.initwcs(d),0<this.wcs&&(this.setWCSSys(this.params.wcssys),this.params.wcssys0=this.params.wcssys.trim(),this.setWCSUnits(this.params.wcsunits))}catch(p){a.log("could not init wcs",p)}else this.wcs=0;
this.initLCS(this.raw.header)}return this}};
a.Image.prototype.mkRawDataFromHDU=function(c,b){var d,e,f,g,h;
$.isArray(c)||a.isTypedArray(c)||
c instanceof ArrayBuffer?($.isArray(c[0])&&(c=c.reduce(function(a,b){return a.concat(b)})),g={image:c}):"object"===typeof c?g=c:a.error("unknown or missing input for HDU creation");
g.data&&!g.image&&(g.image=g.data);
g.image||a.error("data missing from JS9 FITS object");
2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");
b?this.file=b:g.filename&&(this.file=g.filename);
this.file=this.file||a.ANON;
this.id||(this.oid=this.file.split("/").reverse()[0],this.id=a.getImageID(this.oid,this.display.id));
this.raw&&(d=this.raw.width,f=this.raw.height,h=this.raw.bitpix);
this.raw={};
this.raw.hdu=g;
g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):d&&f&&(this.raw.width=d,this.raw.height=f);
g.bitpix?this.raw.bitpix=g.bitpix:h&&(this.raw.bitpix=h);
if("base64"===g.encoding){e=window.atob(g.image);
g.image=new ArrayBuffer(e.length);
f=new Uint8Array(g.image);
for(d=0;
d<e.length;
d++)f[d]=e.charCodeAt(d)}if($.isArray(g.image)||g.image instanceof ArrayBuffer)switch($.isArray(g.image[0])&&(g.image=g.image.reduce(function(a,b){return a.concat(b)})),this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);
break;
case 16:this.raw.data=new Int16Array(g.image);
break;
case -16:this.raw.data=new Uint16Array(g.image);
break;
case 32:this.raw.data=new Int32Array(g.image);
break;
case -32:this.raw.data=new Float32Array(g.image);
break;
case -64:this.raw.data=new Float64Array(g.image)}else this.raw.data=g.image;
g.head?this.raw.header=g.head:(this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix);
this.raw.card=g.card;
if(g.dmin&&g.dmax)this.raw.dmin=g.dmin,this.raw.dmax=g.dmax;
else{this.raw.dmin=Number.MAX_VALUE;
this.raw.dmax=Number.MIN_VALUE;
f=this.raw.width*this.raw.height;
for(d=0;
d<f;
d++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[d]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[d])}this.imtab=g.table?"table":"image";
this.object=this.raw.header.OBJECT;
this.binning.bin="table"===this.imtab?Number(g.table.bin)||1:1;
if(a.initwcs)try{e=a.raw2FITS(this.raw),this.wcs=a.initwcs(e),0<this.wcs&&(this.setWCSSys(this.params.wcssys),this.params.wcssys0=this.params.wcssys.trim(),this.setWCSUnits(this.params.wcsunits))}catch(j){a.log("could not init wcs",j)}else this.wcs=0;
this.initLCS(this.raw.header);
if(isNaN(this.params.scalemin)||"dataminmax"===this.params.scaleclipping)this.params.scalemin=this.raw.dmin;

if(isNaN(this.params.scalemax)||"dataminmax"===this.params.scaleclipping)this.params.scalemax=this.raw.dmax;
return this};
a.Image.prototype.mkSection=function(a,b,d){var e=this.primary.sect;
switch(arguments.length){case 0:e.xcen=Math.floor(this.raw.width/2);
e.ycen=Math.floor(this.raw.height/2);
e.width=Math.min(this.raw.width,this.display.canvas.width);
e.height=Math.min(this.raw.height,this.display.canvas.height);
break;
case 1:e.ozoom=e.zoom;
e.zoom=a;
e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width);

e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height);
break;
case 2:e.xcen=parseInt(a,10);
e.ycen=parseInt(b,10);
break;
case 3:e.ozoom=e.zoom,e.xcen=parseInt(a,10),e.ycen=parseInt(b,10),e.zoom=d,e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width),e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height)}e.width=Math.floor(e.width);
e.height=Math.floor(e.height);
e.x0=Math.floor(e.xcen-(e.width+1)/(2*e.zoom)+1);
e.y0=Math.floor(e.ycen-(e.height+1)/(2*e.zoom)+1);
e.x1=Math.floor(e.xcen+e.width/(2*e.zoom));
e.y1=Math.floor(e.ycen+e.height/(2*e.zoom));
0>e.x0&&(e.x1-=e.x0,e.x0=0);
0>e.y0&&(e.y1-=e.y0,e.y0=0);
e.x1>this.raw.width&&(e.x0-=e.x1-this.raw.width,e.x1=this.raw.width);
e.y1>this.raw.height&&(e.y0-=e.y1-this.raw.height,e.y1=this.raw.height);
e.x0=Math.max(0,e.x0);
e.y0=Math.max(0,e.y0)};
a.Image.prototype.mkColorData=function(){var c,b,d=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(d-1)/(f-e);
this.colorData||(this.colorData=[]);
for(c=0;
c<g;
c++)b=this.raw.data[c],this.colorData[c]=b<=e?0:b>=f?d-1:Math.floor((b-e)*h+0.5);
return this};
a.Image.prototype.calcContrastBias=function(c){var b=a.COLORSIZE,d=this.params.bias,e=this.params.contrast;
if(1E-4>d-0.5&&1E-4>e-1)return c;
this.params.invert&&(d=1-d);
c=Math.floor(((c/b-d)*e+0.5)*b);
return 0>c?0:c>=b?b-1:c};
a.Image.prototype.mkColorCells=function(){var c,b,d=a.COLORSIZE;
this.colorCells||(this.colorCells=[]);
for(c=0;
c<d;
c++)b=this.params.invert?d-c-1:c,b=this.calcContrastBias(b),this.colorCells[c]=this.cmapObj.mkColorCell(b);
return this};
a.Image.prototype.mkScaledCells=function(){var c,b,d,e=a.COLORSIZE,f=a.SCALESIZE;
if(!this.colorCells)return this;
if(!this.psColors){d=this.psColors=[];
b=this.params.nancolor;
var g,h,j,l=[];
"#"===b.charAt(0)&&(b=b.slice(1));
b=b.toUpperCase();
for(g=c=0;
6>c;
c+=2,g++)h="0123456789ABCDEF".indexOf(b.charAt(c)),j="0123456789ABCDEF".indexOf(b.charAt(c+1)),l[g]=16*h+j;
d[NaN]=l}switch(this.params.scale){case "linear":for(d=0;
d<f;
d++)c=d/f,c=Math.floor(c*e),this.psColors[d]=this.colorCells[c];
break;
case "log":b=this.params.exp;
for(d=0;
d<f;
d++)c=Math.log(b*d/f+1)/Math.log(b),c=Math.floor(c*e),c>=e&&(c=e-1),this.psColors[d]=this.colorCells[c];
break;
case "pow":b=this.params.exp;
for(d=0;
d<f;
d++)c=(Math.pow(b,d/f)-1)/b,c=Math.floor(c*e),c>=e&&(c=e-1),this.psColors[d]=this.colorCells[c];
break;
case "sqrt":for(d=0;
d<f;
d++)c=d/f,c=Math.floor(Math.sqrt(c*e)),this.psColors[d]=this.colorCells[c];
break;
case "squared":for(d=0;
d<f;
d++)c=d/f,c=Math.floor(c*c*e),
this.psColors[d]=this.colorCells[c];
break;
case "asinh":for(d=0;
d<f;
d++)c=d/f,b=10*c,c=Math.floor(Math.log(b+Math.sqrt(b*b+1))/3*e),c>=e&&(c=e-1),this.psColors[d]=this.colorCells[c];
break;
case "sinh":for(d=0;
d<f;
d++)c=d/f,b=3*c,c=Math.floor((Math.exp(b)-Math.exp(-b))/2/10*e),c>=e&&(c=e-1),this.psColors[d]=this.colorCells[c];
break;
default:a.log("unknown scale '"+this.params.scale+"'")}return this};
a.Image.prototype.mkPrimaryImage=function(){var c,b,d,e,f,g,h,j,l,n,m,q,p,k,r,s,u,w,v,x=this,y=this,z=this,t=!1,D=255;
if(!this.primary||!this.psColors)return this;
if(a.globalOpts.rgb.mode&&(this===a.globalOpts.rgb.rim||this===a.globalOpts.rgb.gim||this===a.globalOpts.rgb.bim))t=!0;
t&&(x=a.globalOpts.rgb.rim,y=a.globalOpts.rgb.gim,z=a.globalOpts.rgb.bim);
c=this.primary;
b=c.sect;
if(!c.img||c.img.width!==b.width||c.img.height!==b.height)c.img=this.display.context.createImageData(b.width,b.height);
c=c.img;
this.params.maskInvert?(r=this.params.alpha2,s=this.params.alpha1):(r=this.params.alpha1,s=this.params.alpha2);

e=b.y1-1;
for(g=0;
e>=b.y0;
e--,g++){p=e*this.raw.width;
j=g*b.zoom;
d=b.x0;
for(f=0;
d<b.x1;
d++,f++){t?(x&&(u=x.colorData[p+d]),y&&(w=y.colorData[p+d]),z&&(v=z.colorData[p+d])):m=this.colorData[p+d];
this.maskData&&(D=0<this.maskData[p+d]?r:s);
h=f*b.zoom;
for(l=0;
l<b.zoom;
l++){n=Math.floor(j+l);
k=n*b.width;
for(n=0;
n<b.zoom;
n++)q=Math.floor(h+n),q=4*(k+q),t?(c.data[q]=x?x.psColors[u][0]:0,c.data[q+1]=y?y.psColors[w][1]:0,c.data[q+2]=z?z.psColors[v][2]:0):(c.data[q]=this.psColors[m][0],c.data[q+1]=this.psColors[m][1],c.data[q+2]=this.psColors[m][2]),c.data[q+3]=D}}}return this};
a.Image.prototype.displayImage=function(a){var b,d;
d=this.primary;
var e=this.display,f={},g=function(a){a=a.trim();
f[a]=!0;
switch(a){case "colors":f.scaled=!0;
f.primary=!0;
break;
case "scaled":f.primary=!0}};
if(!1===a)this.displayMode=!1;
else if(!0===a&&(this.displayMode=!0,a="all"),this.displayMode){a?"all"===a?(a="colors,scaled,primary,display,plugins",f.notify=!0):"display"===a&&(f.notify=!0):a="primary";
a.split(",").forEach(g);
f.display=!0;
f.plugins=!0;
f.colors&&this.mkColorData();
f.scaled&&(this.mkColorCells(),this.mkScaledCells());
f.primary&&this.mkPrimaryImage();
f.display&&(this.ix=Math.floor((e.canvas.width-d.img.width)/2),this.iy=Math.floor((e.canvas.height-d.img.height)/2),e.context.clear(),e.context.putImageData(d.img,this.ix,this.iy),this.displayShapeLayers(),f.notify&&this.notifyHelper(),e.image=this);
if(f.plugins)for(b in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(b)&&(a=this.display.pluginInstances[b],d=a.plugin.opts,a.isActive("onimagedisplay")))try{d.onimagedisplay.call(a,this)}catch(h){a.errLog("onimagedisplay",h)}return this}};
a.Image.prototype.refreshImage=function(c,b){var d,e;
this.binning.obin=this.binning.bin;
this.mkRawDataFromHDU(c);
e=this.binning.obin!==this.binning.bin;
this.mkSection();
this.displayImage("colors");
if(e){for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.refreshShapes(d);
this.updateShapes("regions","all","binning")}if(b)try{a.xeqByName(b,window,this)}catch(f){a.error("in image refresh callback",f)}};
a.Image.prototype.getPan=function(){return{x:(this.primary.sect.x0+this.primary.sect.x1)/2+1,y:(this.primary.sect.y0+this.primary.sect.y1)/2+1}};
a.Image.prototype.setPan=function(a,b){var d;
0===arguments.length&&(a=this.raw.width/2,b=this.raw.height/2);
this.mkSection(a,b);
this.displayImage("primary");
for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.layers[d].opts.panzoom&&this.refreshShapes(d);
return this};
a.Image.prototype.getZoom=function(){return this.primary.sect.zoom};
a.Image.prototype.setZoom=function(a){var b,d;
b=this.primary.sect.zoom;
switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=b*parseFloat(a.slice(1));
break;
case "/":a=b/parseFloat(a.slice(1));
break;
case "I":case "i":a=2*b;
break;
case "O":case "o":a=b/2;
break;
case "T":case "t":a=Math.min(this.display.width,this.display.height)/Math.max(this.raw.width,this.raw.height);
break;
default:a=parseFloat(a)}break;
case "number":break;
default:return}this.mkSection(a);

this.displayImage("primary");
for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.layers[d].opts.panzoom&&this.refreshShapes(d);
return this};
a.Image.prototype.imageToLogicalPos=function(a,b){var d,e=a.x,f=a.y,g="image";
b=b||this.params.lcs||"image";
switch(b){case "physical":this.lcs.physical&&(g=b,d=this.lcs.physical.reverse);
break;
case "detector":this.lcs.detector&&(g=b,d=this.lcs.detector.reverse);
break;
case "amplifier":this.lcs.amplifier&&(g=b,d=this.lcs.amplifier.reverse)}d&&(e=a.x*d[0][0]+a.y*d[1][0]+d[2][0],f=a.x*d[0][1]+a.y*d[1][1]+d[2][1]);
return{x:e,y:f,sys:g}};
a.Image.prototype.logicalToImagePos=function(a,b){var d,e={x:a.x,y:a.y};
b=b||this.params.lcs||"image";
switch(b){case "physical":this.lcs.physical&&(d=this.lcs.physical.forward);
break;
case "detector":this.lcs.detector&&(d=this.lcs.detector.forward);
break;
case "amplifier":this.lcs.amplifier&&(d=this.lcs.amplifier.forward)}d&&(e.x=a.x*d[0][0]+a.y*d[1][0]+d[2][0],e.y=a.x*d[0][1]+a.y*d[1][1]+d[2][1]);
return e};

a.Image.prototype.displayToImagePos=function(a){var b=this.primary,d=this.primary.sect,e={};
1>=d.zoom?(e.x=(a.x-this.ix)/d.zoom+d.x0+1,e.y=(b.img.height-1-(a.y-this.iy))/d.zoom+d.y0+1):(e.x=(a.x-this.ix)/d.zoom+d.x0+1-0.5,e.y=(b.img.height-1-(a.y-this.iy))/d.zoom+d.y0+1-0.5);
return e};
a.Image.prototype.imageToDisplayPos=function(a){var b=this.primary,d=this.primary.sect,e={};
1>=d.zoom?(e.x=(a.x-1-d.x0)*d.zoom+this.ix,e.y=(d.y0-(a.y-1))*d.zoom+(b.img.height-1)+this.iy):(e.x=(a.x-1+0.5-d.x0)*d.zoom+this.ix,e.y=(d.y0-(a.y-1+0.5))*d.zoom+(b.img.height-1)+this.iy);
return e};
a.Image.prototype.logicalToDisplayPos=function(a){return this.imageToDisplayPos(this.logicalToImagePos(a))};
a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};
a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};
a.Image.prototype.setWCSSys=function(c){if("image"===c)this.params.wcssys="image",this.params.wcsunits="pixels";
else if("physical"===c)this.params.wcssys="physical",this.params.wcsunits="pixels";
else if(this.wcs&&0<this.wcs){"native"===c&&(c=this.params.wcssys0);
if(c=a.wcssys(this.wcs,c))this.params.wcssys=c.trim(),c="pixels"===this.params.wcsunits?a.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(c),this.updateShapes("regions","all","update");return this}};
a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};
a.Image.prototype.setWCSUnits=function(c){var b;
if("pixels"===c)this.params.wcssys="physical",this.params.wcsunits="pixels";
else{if(this.wcs&&0<this.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)b=a.imageOpts.wcssys,this.setWCSSys(this.wcs,b);
if(c=a.wcsunits(this.wcs,c))this.params.wcsunits=c.trim(),this.updateShapes("regions","all","update")}return this}};
a.Image.prototype.notifyHelper=function(){var c,b=this;
a.helper.connected&&this.file!==a.ANON&&a.helper.send("image",{image:this.file},function(d){var e,f,g;
"object"===typeof d?(e=d.stdout,d.stderr&&1<a.DEBUG&&a.log(d.stderr)):e=d;
if(e){d=e.trim().split(/ +/);
if((e=a.lookupImage(d[0],b.display.id||a.DEFID))&&!e.fitsFile){f=d[1];
if("?"!==f){if(a.analOpts.dataDir)g=f.lastIndexOf("/")+1,e.fitsFile=a.analOpts.dataDir+"/"+f.slice(g);
else{e.fitsFile=f;
if(0>e.fitsFile.indexOf("/")&&(c=e.file.match(/.*\//)))e.fitsFile=c+e.fitsFile;
a.analOpts.prependJS9Dir&&"/"!==e.fitsFile.charAt(0)&&(e.fitsFile="$JS9_DIR/"+e.fitsFile)}1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",e.file,e.fitsFile)}f=d[2];
"?"!==f&&(e.fitsExt=f.match(/\[.*\]/))}"wcs"===d[3]?(b.helperCoords="wcs",b.params.wcssys0=d[4],b.params.wcssys||(b.setWCSSys(b.params.wcssys),b.setWCSUnits(b.params.wcsunits))):"pix"===d[3]&&(b.helperCoords="pix",b.params.wcssys0=b.params.lcs,"image"!==b.params.wcssys&&(b.params.wcssys=b.params.wcssys0));
b.queried||(b.queryHelper("all"),b.queried=!0)}});
return this};
a.Image.prototype.queryHelper=function(c){var b=this;
c=c||"all";
if(a.helper.connected&&("all"===c||"getAnalysis"===c))this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(d){if(d)try{b.analysisPackages=JSON.parse(d)}catch(c){a.log("can't get analysis",c)}});
return this};
a.Image.prototype.expandMacro=function(c,b){var d,e,f=this;
if(c)return d=c.replace(/\$(\w+)/g,function(d,c){var j,l;
switch(c){case "id":l=f.display.divjq.attr("id");
break;
case "png":l=f.id;
break;
case "filename":f.fitsFile||a.error("no FITS file for "+f.id);
l=f.fitsFile;
break;
case "ext":l=f.fitsExt||"[]";
break;
case "sregions":l=f.listRegions("source",!1).replace(/\s+/g,
"");
break;
case "bregions":l=f.listRegions("background",!1).replace(/\s+/g,"");
break;
case "regions":l=f.listRegions("all",!1).replace(/\s+/g,"");
break;
default:if(b){e=b.length;
for(j=0;
j<e;
j++)if(b[j].name===c){l=b[j].value;
break}l||(l="false")}l||(l=d)}return l})};
a.Image.prototype.lookupAnalysis=function(a){var b,d,e,f=null;
if(this.analysisPackages){for(d=0;
d<this.analysisPackages.length&&!f;
d++){e=this.analysisPackages[d];
for(b=0;
b<e.length;
b++){f=e[b];
if(f.xclass&&f.xclass+":"+f.name===a)break;

f=null}}if(f)return f;
for(d=0;
d<this.analysisPackages.length&&!f;
d++){e=this.analysisPackages[d];
for(b=0;
b<e.length;
b++){f=e[b];
if(f.name===a)break;
f=null}}}return f};
a.Image.prototype.runAnalysis=function(c,b,d){var e,f=this,g={};
if(a.helper.connected&&this.analysisPackages)if(e=this.lookupAnalysis(c)){e.action&&(g.cmd=this.expandMacro(e.action,b));
if(e.keys){g.keys={};
for(c=0;
c<e.keys.length;
c++)g.keys[e.keys[c]]=this.expandMacro("$"+e.keys[c],b)}g.id=this.expandMacro("$id");
g.image=this.file;
g.fits=this.fitsFile;
g.rtype=e.rtype;
switch(a.helper.type){case "nodejs":case "socket.io":b=e.xclass?e.xclass+":"+e.name:e.name;
break;
default:b="runAnalysis"}a.helper.send(b,g,function(b){var c;
c="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};
c.errcode=c.errcode||0;
if(d)d(c.stdout,c.stderr,c.errcode,e);
else{if(c.errcode||c.stderr)b=c.stderr?c.stderr:sprintf("ERROR: while executing %s [%s]",e.name,c.errcode),a.error(b,a.analOpts.epattern);
switch(e.rtype){case "text":case void 0:f.displayAnalysis("text",c.stdout);
break;
case "plot":f.displayAnalysis("plot",c.stdout);
break;
case "alert":c.stdout&&alert(c.stdout);
break;
case "fits":a.Load(c.stdout,{display:f.display});
break;
case "png":a.Load(c.stdout,{display:f.display});
break;
case "none":break;
default:a.error("unknown analysis result type: "+e.rtype)}}})}else a.error("could not find analysis task: "+c)};
a.Image.prototype.displayAnalysis=function(c,b,d){var e,f,g,h=a.lightOpts[a.LIGHTWIN];
d=d||"AnalysisResults: "+(this.fitsFile||this.id);
e="Analysis_"+a.uniqueID();
switch(c){case "text":f="<div class='JS9Analysis'></div>";
b&&(f+="<pre class='JS9AnalysisText'>"+b+"</pre>");
f=a.lightWin(e,"inline",f+"</div>",d,h.textWin);
break;
case "plot":try{g=JSON.parse(b)}catch(j){a.error("can't plot return data: "+b,j)}if(!g)return;
f=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",e,e);
f=a.lightWin(e,"inline",f,d,h.plotWin);
b=$("#"+e+" #"+e+"Plot");
if(g.data)try{$.plot(b,[g],this.params.plotOpts)}catch(l){a.error("can't plot data",l)}break;
case "params":f=a.lightWin(e,"ajax",b,d,h.paramWin);
break;
case "dpath":f=a.lightWin(e,"ajax",b,d,h.dpathWin)}return f};
a.Image.prototype.loadAuxFile=function(c,b){var d=this,e,f,g,h,j=a.auxFiles.length,l=[],n=function(){d.aux[f.name]=f;
a.Image.prototype.mkOffScreenCanvas.call(h);
a.Image.prototype.mkRawDataFromPNG.call(h);
if(b)try{a.xeqByName(b,window,d,f)}catch(c){a.error("in aux mask onload callback",c)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)},m=function(c){d.aux[f.name]=f;
f.regions=c;
if(b)try{a.xeqByName(b,window,d,f)}catch(e){a.error("in aux region onload callback",e)}},q=function(c){d.aux[f.name]=f;
f.text=c;
if(b)try{a.xeqByName(b,window,d,f)}catch(e){a.error("in aux text onload callback",e)}},p=function(b,c){a.log(sprintf("could not load auxiliary file: %s [%s]",f.url,c))};
if(c&&j){for(e=0;
e<j;
e++)f=a.auxFiles[e],f.image&&!f.regex&&(f.regex=RegExp(f.image));
g=c.split(":");
for(e=0;
e<j;
e++)if(f=a.auxFiles[e],g[0]===f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(k){a.error("in aux mask callback",k)}}else l.push(f);
break;
case "regions":if(f.layer){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(r){a.error("in aux regions callback",r)}}else l.push(f);
break;
case "text":if(f.text){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(s){a.error("in aux text callback",s)}}else l.push(f)}for(e=0;
e<l.length;
e++)switch(f=l[e],f.type){case "mask":f.im={};
h=f.im;
h.type="aux";
h.file=f.url;
h.id=h.file.split("/").reverse()[0];
h.params={};
h.params.scalemin=Number.Nan;
h.params.scalemax=Number.Nan;
h.png={};
h.png.image=new Image;
$(h.png.image).on("load",n).on("error",p);
h.png.image.src=a.InstallDir(f.url);
break;
case "regions":f.layer=this.display.newShapeLayer(c,a.Regions.opts);
g=a.InstallDir(f.url);
$.ajax({url:g,cache:!1,dataType:"json",success:m,error:p});
break;
case "text":g=a.InstallDir(f.url),
$.ajax({url:g,cache:!1,dataType:"text",success:q,error:p})}}};
a.Image.prototype.updateValpos=function(c,b){var d,e,f,g,h;
d=null;
e=function(a,b){return a.toFixed(b||3)};
f=function(a,b){var c="",d="";
0>a&&(a=Math.abs(a),d="-");
for(c+=a;
c.length<b;
)c="0"+c;
return d+c};
if(this.params.valpos){void 0===b&&(b=!0);
if(this.valpos)return b&&this.displayMessage("info",this.valpos),this.valpos;
g={x:c.x,y:c.y,sys:"image"};
h="image"===this.params.wcssys?g:this.imageToLogicalPos(c);
d=this.raw.data[Math.floor(c.y-
0.5)*this.raw.width+Math.floor(c.x-0.5)];
switch(this.raw.bitpix){case 8:case 16:case -16:case 32:f=f(d,3);
break;
case -32:f=e(d,3);
break;
case -64:f=e(d,6);
break;
default:f=f(d,3)}e="value("+f+") "+h.sys+"("+e(h.x)+", "+e(h.y)+")";
d={ix:g.x,iy:g.y,isys:"image",px:h.x,py:h.y,psys:h.sys,ra:"",dec:"",wcssys:"",val:d,val3:f,vstr:e,id:this.id,file:this.file,object:this.object};
0<this.wcs&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys)&&(g=a.pix2wcs(this.wcs,c.x,c.y).trim().split(/\s+/),e=e+" "+g[2]+"("+g[0]+", "+g[1]+")",d.ra=g[0],d.dec=g[1],d.wcssys=g[2],d.vstr=e);
b&&this.displayMessage("info",d)}return d};
a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};
a.Image.prototype.setColormap=function(c,b,d){switch(arguments.length){case 1:case 3:switch(c){case "rgb":a.globalOpts.rgb.mode=!a.globalOpts.rgb.mode;
break;
case "invert":this.params.invert=!this.params.invert;
break;
case "reset":this.params.invert=a.imageOpts.invert;
this.params.contrast=a.imageOpts.contrast;
this.params.bias=a.imageOpts.bias;
break;
default:switch(this.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;
break;
case "green":a.globalOpts.rgb.gim=null;
break;
case "blue":a.globalOpts.rgb.bim=null}this.cmapObj=a.lookupColormap(c);
this.params.colormap=this.cmapObj.name;
switch(c){case "red":a.globalOpts.rgb.rim=this;
break;
case "green":a.globalOpts.rgb.gim=this;
break;
case "blue":a.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(b)||(this.params.contrast=b),isNaN(d)||(this.params.bias=d));
break;
case 2:isNaN(c)||(this.params.contrast=c),isNaN(b)||(this.params.bias=b)}this.displayImage("colors");
return this};
a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax}};
a.Image.prototype.setScale=function(c,b,d){var e=this,f=function(b){0<=a.scales.indexOf(b)?e.params.scale=b:a.error("unknown scale: "+b)};
if(arguments.length){switch(arguments.length){case 1:f(c);

break;
case 2:this.params.scalemin=parseInt(c,10);
this.params.scalemax=parseInt(b,10);
this.mkColorData();
break;
default:f(c),this.params.scalemin=parseInt(b,10),this.params.scalemax=parseInt(d,10),this.mkColorData()}this.displayImage("scaled")}return this};
a.Image.prototype.zscale=function(c){var b,d,e;
if(!a.zscale||!this.raw||!this.raw.data)return this;
b=this.raw.data;
d=b.length*b.BYTES_PER_ELEMENT;
try{e=Module._malloc(d)}catch(f){a.error("image too large for zscale")}d=new Uint8Array(Module.HEAPU8.buffer,e,d);
d.set(new Uint8Array(b.buffer));
b=a.zscale(d.byteOffset,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);
Module._free(d.byteOffset);
b=b.trim().split(" ");
this.params.z1=parseFloat(b[0]);
this.params.z2=parseFloat(b[1]);
c&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);
return this};
a.Colormap=function(c,b,d,e){this.name=c;
switch(arguments.length-1){case 1:this.type="lut";
this.colors=b;
break;
case 3:this.type="sao";
this.vertices=[];
this.vertices[0]=b;
this.vertices[1]=d;
this.vertices[2]=e;
break;
default:a.error("colormap requires name and 1 or 3 array arg")}a.colormaps.push(this);
1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)};
a.Colormap.prototype.mkColorCell=function(c){var b,d=a.COLORSIZE,e=[0,0,0];
switch(this.type){case "sao":var f,g;
c/=d;
for(f=0;
3>f;
f++){g=this.vertices[f];
b=g.length;
for(d=0;
d<b&&!(g[d][0]>c);
d++);
d=0===d?g[0][1]:d===b?g[b-1][1]:(b=(g[d][1]-g[d-1][1])/(g[d][0]-g[d-1][0]))?b*(c-g[d-
1][0])+g[d-1][1]:g[d][1];
e[f]=255*d}break;
case "lut":f=this.colors.length;
c=Math.floor(c*f/d+0.5);
0<=c&&c<f&&(e[0]=255*this.colors[c][0],e[1]=255*this.colors[c][1],e[2]=255*this.colors[c][2]);
break;
default:a.error("unknown colormap type")}return e};
a.Display=function(c){this.divjq=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c);
this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);
this.id=this.divjq.attr("id");
this.divjq.addClass("JS9").css("width",a.WIDTH).css("height",a.HEIGHT);
this.width=parseInt(this.divjq.css("width"),10);
this.height=parseInt(this.divjq.css("height"),10);
this.canvas=document.createElement("canvas");
this.canvasjq=$(this.canvas).addClass("JS9Image").css("z-index",a.ZINDEX).attr("width",a.WIDTH).attr("height",a.HEIGHT);
this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);
this.context=this.canvas.getContext("2d");
a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);
this.image=null;
this.pluginInstances={};
this.layers={};
this.x=0;
for(c=this.canvas;
c;
c=c.offsetParent)this.x+=c.offsetLeft;
this.y=0;
for(c=this.canvas;
c;
c=c.offsetParent)this.y+=c.offsetTop;
this.initMessages();
this.divjq.on("mouseover",this,function(b){return a.mouseOverCB(b)});
this.divjq.on("mousedown touchstart",this,function(b){return a.mouseDownCB(b)});
this.divjq.on("mousemove touchmove",this,function(b){return a.mouseMoveCB(b)});
this.divjq.on("mouseup touchend",this,function(b){return a.mouseUpCB(b)});
this.divjq.on("mouseout",this,function(b){return a.mouseOutCB(b)});
this.divjq.on("keypress",this,function(b){return a.keyPressCB(b)});
this.divjq.on("keydown",this,function(b){return a.keyDownCB(b)});
window.hasOwnProperty("Fitsy")&&(this.divjq.on("dragenter",this,function(a){return Fitsy.dragenter(this.id,a.originalEvent)}),this.divjq.on("dragover",this,function(a){return Fitsy.dragover(this.id,a.originalEvent)}),this.divjq.on("dragexit",this,function(a){return Fitsy.dragexit(this.id,a.originalEvent)}),this.divjq.on("drop",this,function(a){return Fitsy.dragdrop(this.id,a.originalEvent)}),Fitsy.options=Fitsy.options||{},Fitsy.options.error=a.error,Fitsy.options.waiting=a.waiting);
window.hasOwnProperty("Fitsy")&&this.divjq.append('<div style="visibility:hidden;position:relative;top:-50;left:-50"> <input type="file" id="openLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0;i<this.files.length;i++){JS9.Load(this.files[i], {display:\''+this.id+"'});}\"> </div>");

a.displays.push(this);
a.DEBUG&&a.log("JS9 display:  %s (%d,%d)",this.id,this.x,this.y)};
a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",a.MESSZINDEX).appendTo(this.divjq);
this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);
this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);
return this};
a.Display.prototype.displayPlugin=function(c){var b,d,e,f,g,h,j,l;
h=this.pluginInstances[c.name];

switch(a.globalOpts.winType){case "light":b=a.lightOpts[a.LIGHTWIN];
if(!h||!h.status){if(d=c.name.replace(/\s/g,"_"),e=this.id+"_"+d+"_lightDiv",f=this.id+"_"+d+"_outerDiv",d=this.id+"_"+d+"_innerDiv",h||(g=$("<div>").attr("id",f).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(c.name).attr("id",d).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(g)),g=c.opts.winDims[0]||a.WIDTH,j=c.opts.winDims[1]||a.HEIGHT,l=c.opts.winResize?"1":"0",b=sprintf(b.format,g,j,l),g=c.opts.toolbarHTML&&0<=c.opts.toolbarHTML.search(/\$title/)?"":c.opts.winTitle||"",f=a.lightWin(e,"div",f,g,b),e=$("#"+e+" #"+d),h=a.instantiatePlugin(e,c,f),h.winHandle.onclose=function(){h.winHandle.hide();
h.status="inactive";
return!1},h.status="active",c.opts.plugindisplay)try{c.opts.plugindisplay.call(h,this.image)}catch(n){a.log("plugindisplayCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}}else if("inactive"===h.status){if(h.winHandle&&(h.winHandle.show(),h.status="active",c.opts.plugindisplay))try{c.opts.plugindisplay.call(h,this.image)}catch(m){a.log("plugindisplayCB: %s [%s]\n%s",c.name,m.message,a.strace(m))}}else"active"===h.status&&h.winHandle&&(h.winHandle.hide(),h.status="inactive");
break;
case "new":a.error("external window support for plugins not yet implemented")}};
a.Command=function(c){for(var b in c)c.hasOwnProperty(b)&&(this[b]=c[b]);
c.name||a.error("command has no name");
!c.get&&!c.set&&a.error("command requires get and/or set routine");
a.commands.push(this);

1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};
a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=a,this.image=a.image);
return this};
a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};
a.Console=function(c,b){this.display.conMode=2;
this.hist=[];
this.histtemp=this.histpos=0;
this.histused=!1;
this.consoleConjq=$("<div>").addClass("JS9ConsoleContainer").appendTo(this.divjq);
"light"!==this.winType&&(this.width=parseInt(this.divjq.css("width"),10),this.width||(this.width=c||a.CONWIDTH,this.divjq.css("width",this.width)),this.height=parseInt(this.divjq.css("height"),10),this.height||(this.height=b||a.CONHEIGHT,this.divjq.css("height",this.height)),this.consoleConjq.css("width",this.width).css("height",this.height));
this.consoleConjq.attr("tabindex","0");
this.consoleConjq.on("keydown",this,function(b){return a.consoleKeyDownCB(b)});
this.out("Type 'help' for a list of commands","info");

this.inp()};
a.Console.prototype.inp=function(){this.consoleConjq.find(".JS9CmdIn:last").attr("readonly","readonly");
this.consoleConjq.append(a.consoleHTML.replace(/@@PR@@/g,"js9>"));
this.consoleConjq.find(".JS9CmdIn:last").focus().attr("autocapitalize","off").attr("autocorrect","off").attr("autocomplete","off");
return this};
a.Console.prototype.out=function(a,b){switch(b.toLowerCase()){case "error":a="ERROR: "+a;
b="Error";
break;
case "info":b="Info";
break;
case "out":b="Out";
break;
default:b="Out"}$("<div>").addClass("JS9Cmd"+b).html(a).appendTo(this.consoleConjq);
return this};
a.Console.prototype.xeq=function(){var c,b,d,e,f=this.consoleConjq.find(".JS9CmdIn:last").val(),g=f.replace(/ {2,}/g," ").split(" "),h=[];
if(!g[0])return this;
b=g[0];
for(c=1;
c<g.length;
c++)h.push(g[c]);
this.histused||(this.hist[this.hist.length]=f);
this.histpos=this.hist.length;
this.histused=!1;
try{if(d=a.lookupCommand(b))switch(d.getDisplayInfo(this.display),d.getWhich(h)){case "get":e=d.get(h)||"";
this.out(e,"ok");
break;
case "set":(e=d.set(h))&&this.out(e,"ok");
break;
default:e=sprintf("unknown cmd type for '%s'",b),a.error(e)}else e=sprintf("unknown command '%s'",g[0]),0<h.length&&(e=e+" "+h),a.error(e)}catch(j){this.out(j.message,"error")}return this};
a.Info={};
a.Info.CLASS="JS9";
a.Info.NAME="Info";
a.Info.opts={infoURL:"./params/info.html",infoHTML:'<table id="info" class="js9InfoTable"><tr><td>file:</td><td colspan="2"><input type="text" id="id" size="28" value="" readonly="readonly" /></td></tr> <tr><td>object:</td><td colspan="2"><input type="text" id="object" size="28" value="" readonly="readonly" /></td></tr> <tr><td>value:</td><td colspan="2"><input type="text" id="val3" size="28" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="isys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="ix" size="13" value="" readonly="readonly" /></td><td><input type="text" id="iy" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="psys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="px" size="13" value="" readonly="readonly" /></td><td><input type="text" id="py" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="wcssys" size="10" value="" readonly="readonly" /></span></td><td><input type="text" id="ra" size="13" value="" readonly="readonly" /></td><td><input type="text" id="dec" size="13" value="" readonly="readonly" /></td></tr> <tr><td colspan="3"><textarea style="background: #E9E9E9;border: #CCCCCC solid 1px" id="regions" rows="4" cols="40" value="" readonly="readonly" /></td></tr></table>'};

a.Info.init=function(c,b){this.width=parseInt(this.divjq.css("width"),10);
this.width||(this.width=c||a.INFOWIDTH,this.divjq.css("width",this.width));
this.height=parseInt(this.divjq.css("height"),10);
this.height||(this.height=b||a.INFOHEIGHT,this.divjq.css("height",this.height));
this.infoConjq=$("<div>").addClass("JS9Container").append(a.Info.opts.infoHTML).appendTo(this.divjq);
this.jq=this.infoConjq.find("#info")};
a.Info.display=function(c,b,d){var e,f,g,h;
this.display&&this.display.pluginInstances&&(f=this.display.pluginInstances.JS9Info);
d=d?d:f&&"active"===f.status?f:this.display?this.display:this;
if(d===f){switch(typeof b){case "string":g=f.jq.find("#"+c);
0<g.length&&g.val(b);
break;
case "object":for(h in b)if(b.hasOwnProperty(h)){switch(h){case "wcssys":b[h]||(b[h]="wcs")}g=f.jq.find("#"+h);
0<g.length&&g.val(b[h])}}return this}switch(c){case "regions":f=d.regionsArea;
e=";";
break;
case "info":f=d.infoArea;
e="";
break;
default:f=d.infoArea}if(this.primary&&0.8>this.primary.img.height/this.display.canvas.height)c="black";
else switch(c){case "regions":c=a.textColorOpts.regions;
break;
case "info":c=a.textColorOpts.info;
break;
default:c=a.textColorOpts.info}switch(typeof b){case "string":g=b;
break;
case "object":g=b.vstr}""!==e&&(b=g.split(e),2<b.length&&(b=RegExp(e,"g"),g=g.replace(b,"<br>")));
f.css("color",c).html(g);
return this};
a.Image.prototype.displayMessage=a.Info.display;
a.Info.clear=function(a){a?this.displayMessage(a,""):(this.displayMessage("info",""),this.displayMessage("regions",""));
return this};
a.Image.prototype.clearMessage=a.Info.clear;
a.Info.clearMain=function(a){a&&(a.displayMessage("info","",a.display),a.displayMessage("regions","",a.display))};
a.Menubar=function(c){var b,d,e=this;
this.divjq.css("width",c||a.MENUWIDTH);
if(""===a.menubarHTML){a.menubarHTML="<span id='JS9Menus_@@ID@@' class='ui-widget-header ui-corner-all'>";
for(c=0;
c<a.menuButtonOptsArr.length;
c++)b=a.menuButtonOptsArr[c].name,d=a.menuButtonOptsArr[c].label,"#"===b[0]?(b=b.slice(1),a.menubarHTML+="<button type='button' id='"+b+"Menu@@ID@@' class='JS9Button' disabled='disabled'>"+d+" </button>"):a.menubarHTML+="<button type='button' id='"+b+"Menu@@ID@@' class='JS9Button'>"+d+"</button>";
a.menubarHTML+="<button type='button' id='hiddenRegionMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";
a.menubarHTML+="<button type='button' id='hiddenAnchorMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";
a.menubarHTML+="</span>"}this.display=a.lookupDisplay(this.id);
this.display.menubar=this;
c=a.menubarHTML.replace(/@@ID@@/g,this.id);
this.menuConjq=$("<div>").addClass("JS9MenubarContainer").attr("width",a.MENUWIDTH).attr("height",a.MENUHEIGHT).html(c).appendTo(this.divjq);
$(function(){function b(){var c=e.display;
a.bugs.hide_menu&&c.image&&c.image.displayImage("primary")}function c(){var b,d,f,g=[];
if(0<=e.id.search(a.SUPERMENU)){d=e.divjq.data("displays").split(",");
for(b=0;
b<d.length;
b++)(f=a.lookupDisplay(d[b]))&&g.push(f)}g.length||g.push(e.display);
return g}$("#fileMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#fileMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#fileMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,e,f,m=0,q={},p=c()[0];
f=a.images.length;
for(b=0;
b<f;
b++)d=a.images[b],d.display===p&&(e=d.id,q[e]={name:e},p.image&&p.image.id===d.id&&(q[e].icon="sun"),m++);
m||(q.noimg={name:"[no images]",events:{keyup:function(){}}});
q["sep"+m++]="------";
q.open={name:"open ..."};
q.print={name:"print ..."};
q.header={name:"display FITS header"};
q.pageid={name:"display pageid"};
q.close={name:"close image"};
return{callback:function(b,d){c().forEach(function(c){var e,f=c.image;
d.lastmenukey=b;
switch(b){case "close":f&&f.closeImage();
break;
case "header":f&&(f.raw.header?f.displayAnalysis("text",a.raw2FITS(f.raw,!0),"FITSHeader_"+f.id):a.error("no FITS header for "+f.id));
break;
case "pageid":c="<center><p>Usage: js9 -pageid [pageid] ...<p>"+a.helper.pageid||"none</center>";
a.lightWin("fileid"+a.uniqueID(),"inline",c,"page ID",a.lightOpts[a.LIGHTWIN].lineWin);
break;
case "open":a.OpenFileMenu(c);
break;
case "print":f&&f.print();
break;
default:for(e=0;
e<a.images.length;
e++)if(f=a.images[e],c.id===f.display.id&&f.id===b){f.displayImage("display");
f.clearMessage();
break}}})},items:q}}});
$("#viewMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#viewMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#viewMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,e,f,m,q="",p=0,k=0,r={},s=c()[0],u=s.image;
for(b=0;
b<a.plugins.length;
b++)if(d=a.plugins[b],e=d.name,d.opts.menuItem&&"view"===d.opts.menu&&(f=s.pluginInstances[e],!f||f.winHandle))d.xclass!==q&&(p+=1),q=d.xclass,r[e]={name:d.opts.menuItem},f&&"active"===f.status&&(r[e].icon="sun");
r["sep"+p++]="------";
if(u){for(m in u.layers)u.layers.hasOwnProperty(m)&&"main"===u.layers[m].dlayer.dtype&&(k++,r[m]={name:m},u.layers[m].show&&(r[m].icon="sun"));
1<k&&(r.hide={name:"HideAll"},r.show={name:"ShowAll"},r["sep"+p++]="------")}r.valpos={name:"display value/position"};
s.image&&s.image.params.valpos&&(r.valpos.icon="sun");
return{callback:function(b,d){c().forEach(function(c){var e,f,g,h=c.image;

d.lastmenukey=b;
switch(b){case "valpos":h&&(h.params.valpos=!h.params.valpos,h.params.valpos||h.clearMessage());
break;
case "show":case "hide":if(h)for(f in h.layers)h.layers.hasOwnProperty(f)&&"main"===h.layers[f].dlayer.dtype&&h.showShapeLayer(f,b);
break;
default:for(e=0;
e<a.plugins.length;
e++)if(g=a.plugins[e],g.name===b){c.displayPlugin(g);
return}if(h)for(f in h.layers)if(h.layers.hasOwnProperty(f)&&b===f){c=h.layers[f].show?"hide":"show";
h.showShapeLayer(f,c);
break}}})},items:r}}});
$("#zoomMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#zoomMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#zoomMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,f,n,m=0,q=c()[0].image,p={zoomtitle:{name:"Zoom Factors:",disabled:!0}};
for(b=a.imageOpts.zooms;
1<=b;
b--)d=Math.pow(2,-b),f=Math.pow(2,b),n=sprintf("zoom%s",d),f=sprintf("zoom 1/%s",f),p[n]={name:f},q&&q.primary.sect.zoom===d&&(p[n].icon="sun");
for(b=0;
b<=a.imageOpts.zooms;
b++)d=Math.pow(2,b),n=sprintf("zoom%s",d),f=sprintf("zoom %s",d),p[n]={name:f},q&&q.primary.sect.zoom===d&&(p[n].icon="sun");
p["sep"+m++]="------";
p.zoomiotitle={name:"Zoom In/Out:",disabled:!0};
p.zoomIn={name:"zoomIn"};
p.zoomOut={name:"zoomOut"};
p.zoomToFit={name:"zoomToFit"};
p["sep"+m++]="------";
p.zoom={events:{keyup:function(a){var b=$.contextMenu.getInputValues(a.data),c=e.display.image;
switch(a.which||a.keyCode){case 9:case 13:c&&(isNaN(b.zoom)||c.setZoom(b.zoom))}}},name:"numeric zoom value:",type:"text"};
p["sep"+m++]="------";

p.center={name:"pan to center"};
p.reset={name:"reset zoom/pan"};
return{callback:function(a,b){c().forEach(function(c){c=c.image;
b.lastmenukey=a;
if(c)switch(a){case "zoomIn":c.setZoom("x2");
break;
case "zoomOut":c.setZoom("/2");
break;
case "zoomToFit":c.setZoom("tofit");
break;
case "center":c.setPan();
break;
case "reset":c.setZoom("1");
c.setPan();
break;
default:a.match(/^zoom/)&&c.setZoom(a.slice(4))}})},events:{show:function(a){var b=e.display.image,c={};
b&&(c.zoom=String(b.primary.sect.zoom));
$.contextMenu.setInputValues(a,
c)},hide:function(a){var b=e.display.image;
b&&(a.lastmenukey?delete a.lastmenukey:(a=$.contextMenu.getInputValues(a),isNaN(a.zoom)||b.setZoom(a.zoom)))}},items:p}}});
$("#scaleMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#scaleMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#scaleMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,f,n=0,m={},q=c()[0],p=function(a,b){isNaN(b.scalemin)||(a.params.scalemin=b.scalemin);
isNaN(b.scalemax)||(a.params.scalemax=b.scalemax);

a.displayImage("colors")},k=function(a){var b=$.contextMenu.getInputValues(a.data),c=e.display.image;
switch(a.which||a.keyCode){case 9:case 13:p(c,b)}};
m.scaletitle={name:"Scaling Algorithms:",disabled:!0};
for(b=0;
b<a.scales.length;
b++)f=d=a.scales[b],m[d]={name:f},q.image&&q.image.params.scale===d&&(m[d].icon="sun");
m["sep"+n++]="------";
m.scalemin={events:{keyup:k},name:"low value for clipping:",type:"text"};
m.scalemax={events:{keyup:k},name:"high value for clipping:",type:"text"};
m["sep"+n++]=
"------";
m.dminmax={name:"set values to data min/max"};
m.zscale={name:"set values to zscale z1/z2"};
return{callback:function(a,b){c().forEach(function(c){c=c.image;
b.lastmenukey=a;
if(c)switch(a){case "dminmax":return c.params.scaleclipping="dataminmax",c.params.scalemin=c.raw.dmin,c.params.scalemax=c.raw.dmax,$.contextMenu.setInputValues(b,{scalemin:String(c.params.scalemin),scalemax:String(c.params.scalemax)}),c.displayImage("colors"),!1;
case "zscale":return(!c.params.z1||c.params.z2)&&c.zscale(!1),c.params.scaleclipping="zscale",c.params.scalemin=c.params.z1,c.params.scalemax=c.params.z2,$.contextMenu.setInputValues(b,{scalemin:String(c.params.scalemin),scalemax:String(c.params.scalemax)}),c.displayImage("colors"),!1;
default:c.setScale(a)}})},events:{show:function(a){var b=e.display.image,c={};
b&&(c.scalemin=String(b.params.scalemin),c.scalemax=String(b.params.scalemax));
$.contextMenu.setInputValues(a,c)},hide:function(a){var b=e.display.image;
b&&(a.lastmenukey?delete a.lastmenukey:(a=$.contextMenu.getInputValues(a),p(b,a)))}},items:m}}});
$("#colorMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#colorMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#colorMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,f,n=0,m={},q=c()[0],p=function(a,b){isNaN(b.contrast)||(a.params.contrast=b.contrast);
isNaN(b.bias)||(a.params.bias=b.bias);
a.displayImage("colors")},k=function(a){var b=$.contextMenu.getInputValues(a.data),c=e.display.image;
switch(a.which||a.keyCode){case 9:case 13:p(c,b)}};
m.cmaptitle={name:"Colormaps:",disabled:!0};
for(b=0;
b<a.colormaps.length;
b++)f=d=a.colormaps[b].name,m[d]={name:f},q.image&&q.image.cmapObj.name===d&&(m[d].icon="sun");
m["sep"+n++]="------";
m.contrast={events:{keyup:k},name:"contrast value:",type:"text"};
m.bias={events:{keyup:k},name:"bias value:",type:"text"};
m["sep"+n++]="------";
m.reset={name:"reset contrast/bias"};
m["sep"+n++]="------";
m.invert={name:"invert colormap"};
q.image&&q.image.params.invert&&(m.invert.icon="sun");
m["sep"+n++]="------";

m.rgb={name:"RGB mode"};
a.globalOpts.rgb.mode&&(m.rgb.icon="sun");
return{callback:function(a,b){c().forEach(function(c){c=c.image;
b.lastmenukey=a;
c&&c.setColormap(a)})},events:{show:function(a){var b=e.display.image,c={};
b&&(c.contrast=String(b.params.contrast),c.bias=String(b.params.bias));
$.contextMenu.setInputValues(a,c)},hide:function(a){var b=e.display.image;
b&&(a.lastmenukey?delete a.lastmenukey:(a=$.contextMenu.getInputValues(a),p(b,a)))}},items:m}}});
$("#regionMenu"+e.id).on("mousedown",function(a){a.preventDefault();

$("#regionMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#regionMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var a=c()[0].image,b={regiontitle:{name:"Regions:",disabled:!0},annulus:{name:"annulus"},box:{name:"box"},circle:{name:"circle"},ellipse:{name:"ellipse"},point:{name:"point"},polygon:{name:"polygon"},text:{name:"text"},sep2:"------",listRegions:{name:"listRegions"},listonchange:{name:"listOnChange"},xeqonchange:{name:"xeqOnChange"},deleteRegions:{name:"deleteRegions"}};

a&&a.params.listonchange&&(b.listonchange.icon="sun");
a&&a.params.xeqonchange&&(b.xeqonchange.icon="sun");
return{callback:function(a,b){c().forEach(function(c){c=c.image;
b.lastmenukey=a;
if(c)switch(a){case "deleteRegions":c.removeShapes("regions","all");
c.clearMessage("regions");
break;
case "listRegions":c.listRegions("all",!0);
break;
case "xeqonchange":c.params.xeqonchange=!c.params.xeqonchange;
break;
case "listonchange":c.params.listonchange=!c.params.listonchange;
break;
default:c.addShapes("regions",a,{ireg:!0})}})},items:b}}});
$("#wcsMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#wcsMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#wcsMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,d,e,f=0,m={},q=c()[0];
m.wcssystitle={name:"WCS Systems:",disabled:!0};
for(b=0;
b<a.wcssyss.length;
b++)e=d=a.wcssyss[b],m[d]={name:e},q.image&&q.image.params.wcssys===d&&(m[d].icon="sun");
m["sep"+f++]="------";
m.wcsutitle={name:"WCS Units:",disabled:!0};
for(b=0;
b<a.wcsunitss.length;
b++)e=
d=a.wcsunitss[b],m[d]={name:e},q.image&&q.image.params.wcsunits===d&&(m[d].icon="sun");
return{callback:function(b,d){c().forEach(function(c){var e=RegExp(b);
c=c.image;
d.lastmenukey=b;
c&&(0<=a.wcssyss.join("@").search(e)?c.setWCSSys(b):0<=a.wcsunitss.join("@").search(e)?c.setWCSUnits(b):a.error("unknown wcs sys/units: "+b))})},items:m}}});
$("#analysisMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#analysisMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#analysisMenu"+e.id,zIndex:a.MENUZINDEX,
events:{hide:b},build:function(){var b,d,e,f,m,q=0,p=0,k={};
m=c()[0];
var r=m.image,s="";
for(b=0;
b<a.plugins.length;
b++)if(d=a.plugins[b],f=d.name,d.opts.menuItem&&"analysis"===d.opts.menu&&(e=m.pluginInstances[f],!e||e.winHandle))d.xclass!==s&&(k["sep"+p++]="------",k["sep"+p++]={name:d.xclass+" Plugins:"},k["sep"+(p-1)].disabled=!0),s=d.xclass,k[f]={name:d.opts.menuItem},e&&"active"===e.status&&(k[f].icon="sun"),p++;
0<p&&(k["sep"+p++]="------");
k.remotetitle={name:"Server-side Tasks:",disabled:!0};

if(r&&r.analysisPackages){f=r.analysisPackages;
for(d=0;
d<f.length;
d++){m=f[d];
for(b=0;
b<m.length;
b++)if(!m[b].hidden&&("fits"!==m[b].files||r.fitsFile)&&!("png"===m[b].files&&"fits2png"!==r.source))e=m[b].title,m[b].purl&&(e+=" ..."),k[m[b].name]={name:e},q++}}q||(k.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}});
k["sep"+p++]="------";
k.dpath={name:"set data path ..."};
return{callback:function(b,d){c().forEach(function(c){var e,f,g;
f=c.image;
d.lastmenukey=b;
for(e=0;
e<a.plugins.length;
e++)if(g=a.plugins[e],g.name===b){c.displayPlugin(g);
return}if(f)switch(b){case "dpath":a.globalOpts.dhtmlonload=function(){$("#dataPath").val(a.globalOpts.dataPath)};
a.globalOpts.dhtmlloadid="dataPathForm";
f=f.displayAnalysis("dpath",a.InstallDir(a.analOpts.dpathURL),"Data Path for Drag and Drop");
$(f).data("dispid",c.id);
break;
default:if(e=f.lookupAnalysis(b))e.purl?(f=f.displayAnalysis("params",a.InstallDir(e.purl),e.title+": "+f.fitsFile),$(f).data("dispid",c.id).data("aname",e.name)):f.runAnalysis(e.name)}})},items:k}}});
$("#helpMenu"+e.id).on("mousedown",function(a){a.preventDefault();
$("#helpMenu"+e.id).contextMenu()});
$.contextMenu({selector:"#helpMenu"+e.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,d=1,e="",f={helptitle:{name:"JS9 Help:",disabled:!0}};
for(b in a.helpOpts)a.helpOpts.hasOwnProperty(b)&&(c=a.helpOpts[b],""!==e&&c.type!==e&&(f["sep"+d++]="------",c.heading&&(f["sep"+d++]={name:c.heading+" Help:"},f["sep"+(d-1)].disabled=!0)),e=c.type,f[b]={name:c.title});
f["sep"+d++]="------";
f.about={name:"About JS9"};
return{callback:function(b){switch(b){case "about":alert(sprintf("JS9: image display right in your browser\nversion: %s\nprincipals: Eric Mandel (lead), John Roll (fits,plugins), Alexey Vikhlinin (science,management)\ncontact: saord@cfa.harvard.edu\n%s",a.VERSION,a.COPYRIGHT));
break;
default:a.DisplayHelp(b)}},items:f}}})})};
a.Helper=function(){this.helper=this.connected=!1;
this.type=a.globalOpts.helperType||"sock.io";
this.pageid=null;
this.connect()};
a.Helper.prototype.connectinfo=function(){if(null===a.helper.connected)return"notConfigured";
if(a.helper.connected){var c=sprintf("connected %s %s",a.helper.type,a.helper.url);
a.helper.pageid&&(c+="<p>"+a.helper.pageid);
return c}return sprintf("notConnected %s",a.helper.type)};
a.Helper.prototype.connect=function(c){var b=this;
c&&(this.type=c);
if(this.socket){try{this.socket.disconnect()}catch(d){a.log("warning: can't disconnect from socket")}this.socket=null}this.url=a.globalOpts.helperURL?"http://"+a.globalOpts.helperURL:""===document.domain?"http://localhost":"http://"+document.domain;
switch(this.type){case "none":this.connected=null;
a.Preload(!0);
break;
case "get":case "post":a.globalOpts.helperCGI||a.error("cgi script name missing for helper");
this.url+="/"+a.globalOpts.helperCGI;
this.helper=this.connected=!0;
a.DEBUG&&a.log("JS9 helper: connect: "+this.type);
a.Preload(!0);
break;
case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");
this.url+=":"+a.globalOpts.helperPort;
this.sockurl=this.url+"/socket.io/socket.io.js";
$.ajax({url:this.sockurl,dataType:"script",success:function(){var c,d;
b.socket=io.connect(b.url);
b.socket.on("connect",function(){b.connected=!0;
b.helper=!0;
d=[];
for(c=0;
c<a.displays.length;
c++)d.push(a.displays[c].id);
b.socket.emit("displays",{displays:d},function(a){b.pageid=a});
a.Preload(!0);
a.DEBUG&&a.log("JS9 helper: connect: "+b.type)});
b.socket.on("disconnect",function(){b.connected=!1;
b.helper=!1;
1<a.DEBUG&&a.log("JS9 helper: disconnect")});
b.socket.on("reconnect",
function(){b.connected=!0;
b.helper=!0;
1<a.DEBUG&&a.log("JS9 helper: reconnect")});
b.socket.on("msg",function(b,c){var d,e,f,m=[],q=b.cmd,p=b.id;
a.globalOpts.alerts=!1;
if(a.publics[q]){$.isArray(b.args)||(b.args=[b.args]);
m=$.extend(!0,[],b.args);
p&&m.push({display:p});
try{f=a.publics[q].apply(null,m)}catch(k){f=sprintf("ERROR: %s",k.message)}}else{d=a.lookupCommand(q);
e=a.lookupDisplay(p);
if(d&&e)switch(d.getDisplayInfo(e),b.args?m=$.extend(!0,[],b.args):b.paramlist&&(m=b.paramlist.split(/ +/)),d.getWhich(m)){case "get":try{f=d.get(m)||""}catch(r){f="ERROR: "+r.message}break;
case "set":try{f=d.set(m)||"OK"}catch(s){f="ERROR: "+s.message}break;
default:f=sprintf("ERROR: unknown cmd type for '%s'",q)}else d||(f=sprintf("ERROR: unknown cmd '%s'",q)),e||(f=sprintf("ERROR: unknown display (%s)",p));
a.globalOpts.alerts=!1}c&&c(f)})},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: connect failure: "+c+" "+d)}});
break;
default:a.error("unknown helper type: "+this.type)}};
a.Helper.prototype.send=function(c,b,d){if(!this.connected)return null;

b&&"object"===typeof b?(b.cookie=document.cookie,a.globalOpts.dataPath&&!b.dataPath&&(b.dataPath=a.globalOpts.dataPath+":.")):b={dataPath:"."};
a.TOROOT&&(b.dataPath+=":"+a.TOROOT);
switch(this.type){case "get":case "post":b.key=c;
$.ajax({url:this.url,type:this.type.toUpperCase(),data:b,dataType:"text",success:function(b){"string"===typeof b&&0<=b.search(a.analOpts.epattern)&&a.log(b);
d&&d(b)},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+c+" "+d)}});
break;
case "sock.io":case "nodejs":a.helper.socket.emit(c,b,d)}return this};
a.Fabric={};
a.Fabric.elements="cornerSize cornerColor borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint hasBorders params pub".split(" ");
a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,cornerSize:8*(fabric.isTouchSupported?2:1),transparentCorners:!1,selectionLineWidth:2,centeredScaling:!0,selectable:!0,skipOffset:!0,padding:0,canvas:{selection:!0,zindex:a.SHAPEZINDEX},fill:"transparent"};
a.Fabric.rescaleStrokeWidth=function(c,b){var d=(this.scaleX+this.scaleY)/2;
c=c||1;
c*=d;
!b&&this.params&&(b=this.params.sw1);
"group"===this.type?this.forEachObject(function(d){a.Fabric.rescaleStrokeWidth.call(d,c,b)}):this.setStrokeWidth(b/c)};
a.Fabric.rescaleEvenly=function(){var a;
if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};
fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;
fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;
a.Fabric.newShapeLayer=function(c,b,d){var e,f;
if(this&&c){if(this.layers[c])return this.layers[c];
this.layers[c]={};
f=this.layers[c];
f.params=[];
f.params.sel=null;
f.params.sellayer=null;
d?f.dtype="other":(f.dtype="main",d=this.divjq);
e=d.attr("id")+"-"+c.replace(/\s+/,"_")+"-shapeLayer";
f.display=this;
f.opts=$.extend(!0,{},b);
f.opts.canvas=f.opts.canvas||{};
f.opts.canvas.selection=f.opts.canvas.selection||!0;

f.opts.canvas.zindex=f.opts.canvas.zindex||a.SHAPEZINDEX;
f.el=a.Fabric.elements;
f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(d);
f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",e).attr("width",d.css("width")).attr("height",d.css("height")).appendTo(f.divjq);
f.canvas=new fabric.Canvas(f.canvasjq[0]);
f.canvas.renderOnAddRemove=!1;
f.canvas.selection=f.opts.canvas.selection;
f.canvas.on("mouse:down",function(b){var d,e,l,n;
if(b.target&&f.display.image)d=b.target,e=f.display.image,!a.specialKey(b.e)&&d.params&&(l=(new Date).getTime(),d.params.lasttime&&l-d.params.lasttime<a.DBLCLICK&&(n=!0),d.params.lasttime=l),n?d.params.winid||(a.globalOpts.dhtmlonload=function(){d.pub&&a.Regions.initConfigForm.call(e,d)},a.globalOpts.dhtmlloadid="regionsConfigForm",d.params.winid=e.displayAnalysis("params",a.InstallDir(a.Regions.opts.configURL),"Region Configuration")):("main"===f.dtype&&(e.rclick=1),a.specialKey(b.e)&&("polygon"===b.target.type?(a.Fabric.addPolygonPoint.call(e,c,b.target,b.e),a.Fabric._updateShape.call(e,c,b.target,null,"update")):b.target.polyparams&&(a.Fabric.removePolygonPoint.call(e,c,b.target,b.e),a.Fabric._updateShape.call(e,c,b.target.polyparams.polygon,null,"update"))));
else if(this._selection=this.selection)this.selection=a.specialKey(b.e)});
f.canvas.on("mouse:up",function(){var a,b=[];
if(f.display.image){this.getActiveObject()&&b.push(this.getActiveObject());
this.getActiveGroup()&&(b=this.getActiveGroup().getObjects());
for(a=0;
a<b.length;
a++)b[a].polyparams&&f.canvas.setActiveObject(b[a].polyparams.polygon)}this.selection=this._selection||this.selection});
f.canvas.on("object:scaling",function(a){a.target.rescaleEvenly();
a.target.rescaleBorder()});
f.canvas.on("object:selected",function(b){f.params.sel&&(b.target.params&&f.params.sel!==b.target)&&f.canvas.fire("before:selection:cleared",{target:f.params.sel});
switch(b.target.type){case "polygon":a.Fabric.addPolygonAnchors(f,b.target),f.canvas.renderAll()}b.target.polyparams?f.params.sel=b.target.polyparams.polygon:b.target.params&&(f.params.sel=b.target);
f.display.image&&(f.display.image.layer=c)});
f.canvas.on("before:selection:cleared",function(b){f.params.sel=null;
f.display.image&&(f.display.image.layer=null);
switch(b.target.type){case "polygon":a.Fabric.removePolygonAnchors(f,b.target),f.canvas.renderAll()}});
if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",function(){f.canvas.calcOffset()});
else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});

return f}};
a.Fabric.showShapeLayer=function(c,b){var d=this,e,f,g,h;
if(f=this.getShapeLayer(c)){h=f.canvas;
g=this.display.layers[c];
if("show"===b||!0===b)"show"===b&&(f.show=!0),f.json&&f.show&&h.loadFromJSON(f.json,function(){var b,e,n,m;
h.renderAll();
h.selection=f.opts.canvas.selection;
e=g.opts.canvas.zindex;
g.divjq.css("z-index",e);
for(b in d.layers)if(d.layers.hasOwnProperty(b)&&(c!==b&&d.layers[b].show)&&(n=d.display.layers[b],n.divjq.css("z-index")<e&&(m=n.canvas.getActiveObject())))a.Fabric.removePolygonAnchors(n,m),n.canvas.discardActiveObject();
f.json=null});
else if("hide"===b||!1===b)f.show&&(h.forEachObject(function(b){a.Fabric.removePolygonAnchors(g,b);
b.params&&b.params.winid&&(b.params.winid.close(),b.params.winid=null)}),e=h.toJSON(f.dlayer.el),f.json=JSON.stringify(e),h.selection=!1,g.divjq.css("z-index",0),h.clear()),"hide"===b&&(f.show=!1);
return this}};
a.Fabric.displayShapeLayers=function(){var a;
if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1);
if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0)}};
a.Fabric.getShapeLayer=function(a){var b,d;
if(!a)return null;
d=this.layers[a];
if(!d){b=this.display.layers[a];
if(!b)return null;
this.layers[a]={};
d=this.layers[a];
d.show=!0;
d.nshape=0;
d.dlayer=b;
d.opts=d.dlayer.opts;
d.canvas=d.dlayer.canvas;
d.canvas.calcOffset()}return d};
a.Fabric._parseShapeOptions=function(c,b,d){var e,f,g,h,j,l,n,m={},q={};
h="main"===this.display.layers[c].dtype?this.primary.sect.zoom:1;
j=h/("main"===this.display.layers[c].dtype?this.binning.bin||1:1);
if(b.remove)return{remove:!0};
q.tags=[];
if(b.tags)if("string"===typeof b.tags){f=b.tags.toLowerCase().split(",");
for(c=0;
c<f.length;
c++)q.tags[c]=f[c].trim()}else if($.isArray(b.tags))for(c=0;
c<b.tags.length;
c++)q.tags[c]=b.tags[c].trim();
void 0!==b.angle&&(m.angle=-b.angle);
void 0!==b.x&&void 0!==b.y&&(e=this.imageToDisplayPos(b),m.left=e.x,m.top=e.y);
void 0!==b.left&&(m.left=b.left);
void 0!==b.top&&(m.top=b.top);
void 0===m.left&&(d&&void 0!==d.left?m.left=d.left:(m.left=this.display.canvasjq.attr("width")/2-1,1<h&&(m.left+=0.5*h)));
void 0===m.top&&(d&&void 0!==d.top?m.top=d.top:(m.top=this.display.canvasjq.attr("height")/2-1+1,1<h&&(m.top-=0.5*h)));
b.dx&&(m.left+=b.dx);
b.dy&&(m.top-=b.dy);
switch(b.shape){case "annulus":q.radii=[];
if(void 0!==b.radii)if("string"===typeof b.radii){q.radii=b.radii.replace(/ /g,"").split(",");
for(e=c=0;
c<q.radii.length;
c++)""!==q.radii[c]&&(q.radii[e++]=parseInt(q.radii[c],10))}else q.radii=b.radii;
else{b.ireg&&a.SCALEIREG&&(b.iradius&&(b.iradius/=j),b.oradius&&(b.oradius/=j));
h=(b.oradius-b.iradius)/b.nannuli;
j=b.nannuli+1;
for(c=0;
c<j;
c++)f=b.iradius+h*c,q.radii.push(f)}break;
case "box":b.ireg&&a.SCALEIREG&&(b.width&&(b.width/=j),b.height&&(b.height/=j));
break;
case "circle":b.ireg&&a.SCALEIREG&&b.radius&&(b.radius/=j);
break;
case "ellipse":b.ireg&&a.SCALEIREG&&(b.r1&&(b.r1/=j),b.r2&&(b.r2/=j));
break;
case "point":switch(b.ptshape){case "box":b.width=2*b.ptsize;
b.height=2*b.ptsize;
break;
case "circle":b.radius=b.ptsize;
break;
case "ellipse":b.rx=b.ptsize,b.ry=b.ptsize/2}b.lockRotation=!0;
b.lockScalingX=!0;
b.lockScalingY=!0;
b.hasControls=!1;
b.hasRotatingPoint=!1;
b.hasBorders=!0;
break;
case "polygon":if(b.pts&&b.pts.length){if("string"===typeof b.pts){g=b.pts.replace(/ /g,"").split(",");
f=g.length;
if("string"===typeof g[0])for(c=0;
c<f;
c++)g[c]=parseFloat(g[c]);
b.pts=[];
for(e=c=0;
c<f;
c+=2,e++)b.pts[e]={x:g[c],y:g[c+1]}}f=b.pts.length;
for(c=0;
c<f;
c++)b.pts[c]=this.imageToDisplayPos(b.pts[c]);

b.left&&b.top?g={x:b.left,y:b.top}:(g=a.centroidPolygon(b.pts),m.left=g.x,m.top=g.y);
b.points=[];
for(c=0;
c<f;
c++)e={x:(b.pts[c].x-g.x)/h,y:(b.pts[c].y-g.y)/h},b.points.push(e)}if(b.ireg&&a.SCALEIREG){f=b.points.length;
for(c=0;
c<f;
c++)b.points[c].x/=j,b.points[c].y/=j}}for(l in b)if(b.hasOwnProperty(l))switch(l){case "tags":case "x":case "y":case "dx":case "dy":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;
case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":m[l]=b[l];
break;
case "shape":n=b[l];
break;
default:q[l]=b[l]}if(!(b=q.color)){b=q.tags;
l=q.tagcolors;
var p,k;
l=l||{};
for(p in l)if(l.hasOwnProperty(p)&&(c=p.split("_"),0===$(b).not(c).length&&0===$(c).not(b).length)){k=l[p];
break}if(!k)for(p in l)if(l.hasOwnProperty(p)&&(c=p.split("_"),0===$(b).not(c).length)){k=l[p];
break}if(!k)for(p in l)if(l.hasOwnProperty(p)&&(c=p.split("_"),0===$(c).not(b).length)){k=l[p];
break}b=k=k||d&&d.get("stroke")||l.defcolor||a.globalOpts.defcolor||"#000000"}m.stroke=b;
m.selectColor=m.stroke;
m.cornerColor=m.stroke;
m.borderColor=m.stroke;
void 0!==q.fixinplace&&(d=q.fixinplace,void 0===m.lockMovementX&&(m.lockMovementX=d),void 0===m.lockMovementY&&(m.lockMovementY=d),void 0===m.lockRotation&&(m.lockRotation=d),void 0===m.lockScalingX&&(m.lockScalingX=d),void 0===m.lockScalingY&&(m.lockScalingY=d),void 0===m.hasControls&&(m.hasControls=!d),void 0===m.hasRotatingPoint&&(m.hasRotatingPoint=!d),void 0===m.hasBorders&&(m.hasBorders=!d));
return{shape:n,opts:m,params:q}};
a.Fabric.addShapes=function(c,b,d){var e,f,g,h,j,l,n,m,q,p,k=[],r={};
if((l=this.getShapeLayer(c))&&l.show){n=l.canvas;
"main"===this.display.layers[c].dtype?(m=this.primary.sect.zoom,q=this.binning.bin||1):q=m=1;
if("string"===typeof b)b=[{shape:b}];
else if(!$.isArray(b))if("object"===typeof b)b=[b];
else return;
if("string"===typeof d)try{j=JSON.parse(d)}catch(s){return a.error("can't parse shape opts: "+d,s),null}else j=d;
n.size()||(d=this.display.layers[c],"regions"===c&&d.opts.canvas.zindex++,d.divjq.css("z-index",d.opts.canvas.zindex));
h=$.extend(!0,{},a.Fabric.opts,l.opts,j);
for(g=0;
g<b.length;
g++)if(d=$.extend(!0,{},h,b[g]),f=a.Fabric._parseShapeOptions.call(this,c,d),f.shape&&!f.remove){d=f.opts;
r=f.params;
r.id=++l.nshape;
switch(f.shape){case "annulus":r.shape="annulus";
f=d.top;
p=d.left;
d.top=0;
d.left=0;
if(r.radii)for(e=0;
e<r.radii.length;
e++)d.radius=r.radii[e],k.push(new fabric.Circle(d));
d.top=f;
d.left=p;
d.width=2*d.radius;
d.height=2*d.radius;
e=new fabric.Group(k,d);
break;
case "box":r.shape="box";
e=
new fabric.Rect(d);
break;
case "circle":r.shape="circle";
e=new fabric.Circle(d);
break;
case "ellipse":r.shape="ellipse";
d.rx=r.r1;
d.ry=r.r2;
e=new fabric.Ellipse(d);
break;
case "point":r.shape="point";
switch(r.ptshape){case "box":e=new fabric.Rect(d);
break;
case "circle":e=new fabric.Circle(d);
break;
case "ellipse":e=new fabric.Ellipse(d)}break;
case "polygon":r.shape="polygon";
e=new fabric.Polygon(d.points,d,r.skipOffset);
break;
case "text":r.shape="text";
r.text=r.text||"Double-click to add text here";
if(window.hasOwnProperty("fabric")&&
(!j||!j.strokeWidth))d.strokeWidth="1.4.0"===fabric.version?0:1;
e=new fabric.Text(r.text,d);
break;
default:a.error("unknown shape: "+r.shape)}n.add(e);
r.layerName=c;
r.sw1=e.strokeWidth;
r.listonchange=!1;
e.params=r;
if(l.opts.panzoom)switch(r.shape){case "point":case "text":break;
default:e.scale(m/q)}e.rescaleBorder();
a.Fabric._updateShape.call(this,c,e,null,"add",r)}(void 0===r.redraw||r.redraw)&&n.renderAll();
return r.id}};
a.Fabric.selectShapes=function(a,b,d){var e,f,g,h,j=this;
if(!this.layers||!a||!this.layers[a])return null;
b=b||"all";
a=this.layers[a].canvas;
f=a.getActiveGroup();
g={group:null};
switch(typeof b){case "object":b.params&&(g.group=f&&f.contains(b)?f:null,d.call(j,b,g));
break;
case "number":a.forEachObject(function(a){a.params&&b===a.params.id&&(g.group=f&&f.contains(a)?f:null,d.call(j,a,g))});
break;
case "string":h=b.toLowerCase().replace("box","rect"),"selected"===b?a.getActiveObject()?(a=a.getActiveObject(),a.params&&(g.group=null,d.call(j,a,g))):f&&(g.group=f,f.forEachObject(function(a){a.params&&d.call(j,a,g)})):a.forEachObject(function(a){if(a.params)if(g.group=f&&f.contains(a)?f:null,"all"===b)d.call(j,a,g);
else if(b===a.stroke)d.call(j,a,g);
else if(h===a.type)d.call(j,a,g);
else if(a.params.tags)for(e=0;
e<a.params.tags.length;
e++)b===a.params.tags[e]&&d.call(j,a,g)})}return this};
a.Fabric.updateShapes=function(c,b,d,e){var f=this;
this.selectShapes(c,b,function(b,h){a.Fabric._updateShape.call(f,c,b,h,d,e)});
return this};
a.Fabric._updateShape=function(c,b,d,e,f){var g,h,j,l,n,m,q,p,k={},r=this.layers[c],s=function(a){return a.toFixed(2)};
d=d||{};
f=f||{};
q=this.display;
"main"===this.display.layers[c].dtype?(m=this.primary.sect.zoom,j=this.binning.bin||1):j=m=1;
k.mode=e||"update";
k.id=b.params.id;
k.shape=b.params.shape;
k.layer=c;
k.color=b.stroke;
k.tags=b.params.tags;
e=b.getCenterPoint();
d.group&&(p=d.group.getCenterPoint(),e={x:e.x+p.x,y:e.y+p.y});
p=this.displayToImagePos(e);
k.x=p.x;
k.y=p.y;
k.imsys="image";
k.lcs=this.imageToLogicalPos(p);
"image"===this.params.wcssys?(l=k.x,n=k.y):
(l=k.lcs.x,n=k.lcs.y,k.imsys=k.lcs.sys);
k.angle=-b.angle;
d.group&&(k.angle-=d.group.angle);
for(;
0>k.angle;
)k.angle+=360;
for(;
360<k.angle;
)k.angle-=360;
e=b.scaleX/m*j;
j*=b.scaleY/m;
d.group&&(e*=d.group.scaleX,j*=d.group.scaleY);
switch(k.shape){case "annulus":k.shape="annulus";
k.radii=[];
k.imstr="annulus("+s(l)+", "+s(n)+", ";
h="annulus "+k.x+" "+k.x+" ";
j=b.getObjects();
m=j.length;
for(d=0;
d<m;
d++)l=j[d].radius*e,k.imstr+=s(l),h+=k.x+" "+k.y+" "+(k.x+l)+" "+k.y+" ",k.imstr=d===m-1?k.imstr+")":k.imstr+", ",k.radii.push(l);
break;
case "box":k.shape="box";
k.width=b.width*e;
k.height=b.height*j;
k.imstr="box("+s(l)+", "+s(n)+", "+s(k.width)+", "+s(k.height)+", "+s(k.angle)+")";
h="box "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.width)+" "+k.y+" "+k.x+" "+k.y+" "+k.x+" "+(k.y+k.height)+" "+k.angle*Math.PI/180;
break;
case "circle":k.radius=b.radius*e;
k.imstr="circle("+s(l)+", "+s(n)+", "+s(k.radius)+")";
h="circle "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.radius)+" "+k.y;
break;
case "ellipse":k.r1=b.width*e/2;

k.r2=b.height*j/2;
k.imstr="ellipse("+s(l)+", "+s(n)+", "+s(k.r1)+", "+s(k.r2)+", "+s(k.angle)+")";
h="ellipse "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.r1)+" "+k.y+" "+k.x+" "+k.y+" "+k.x+" "+(k.y+k.r2)+" "+k.angle*Math.PI/180;
break;
case "point":k.width=b.width*e;
k.height=b.height*j;
k.imstr="point("+s(l)+", "+s(n)+")";
h="point "+k.x+" "+k.y;
break;
case "polygon":k.imstr="polygon(";
h="polygon ";
k.pts=[];
for(d=0;
d<b.points.length;
d++)0<d&&(k.imstr+=", ",h+=" "),l={x:k.x+b.points[d].x*e,y:k.y-b.points[d].y*j},l=a.rotatePoint(l,k.angle,{x:k.x,y:k.y}),"image"===this.params.wcssys?k.imstr+=s(l.x)+", "+s(l.y):(m=this.imageToLogicalPos(l),k.imstr+=s(m.x)+", "+s(m.y)),h+=l.x+" "+l.y,k.pts.push(l);
k.imstr+=")";
break;
case "text":k.imstr="# text("+s(k.x)+", "+s(k.y)+") text={"+b.text+"}",k.text=b.text}if(this.wcs&&0<this.wcs){if("regions"===c&&!1!==f.dowcsstr||"regions"!==c&&!0===f.dowcsstr)k.wcsstr=a.reg2wcs(this.wcs,h).replace(/;$/,"");
h=a.pix2wcs(this.wcs,p.x,p.y).trim().split(/\s+/);
k.ra=h[0];
k.dec=h[1];

k.wcssys=h[2]}b.set("pub",k);
b.params.winid&&($(b.params.winid).is(":visible")?a.Regions.initConfigForm.call(this,b):b.params.winid=null);
if(f.nocb)return k;
if("regions"===c&&this.params.xeqonchange&&r.show&&this.onregionschange)try{this.params.xeqonchange=!1,a.xeqByName(this.onregionschange,window,this,k)}catch(u){a.log("error in xeqonchange: %s [%s]\n%s",this.id,u.message,a.strace(u))}finally{this.params.xeqonchange=!0}if(this.params.xeqonchange&&r.show&&r.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(r.opts.onchange,window,this,k)}catch(t){a.log("error in onchange: %s [%s]\n%s",this.id,t.message,a.strace(t))}finally{this.params.xeqonchange=!0}f="on"+c+"change";
for(g in q.pluginInstances)if(q.pluginInstances.hasOwnProperty(g)&&(c=q.pluginInstances[g],b=c.plugin.opts,c.isActive(f)))try{b[f].call(c,this,k)}catch(v){c.errLog(f,v)}return k};
a.Fabric.removeShapes=function(c,b){var d=this,e,f;
if(e=this.getShapeLayer(c))return f=e.canvas,this.selectShapes(c,b,function(b,e){a.Fabric._updateShape.call(d,c,b,e,"remove");
e&&e.group&&e.group.remove(b);
b.params&&b.params.winid&&b.params.winid.close();
f.remove(b)}),f.getActiveGroup()&&f.discardActiveGroup(),f.renderAll(),this};
a.Fabric.getShapes=function(a,b){var d=[];
this.selectShapes(a,b,function(a){d.push(a.pub||{})});
return d};
a.Fabric.changeShapes=function(c,b,d){var e,f,g,h,j,l,n,m,q,p,k,r,s=this;
if((j=this.getShapeLayer(c))&&d)return l=j.canvas,"main"===this.display.layers[c].dtype?(k=this.primary.sect.zoom,r=this.binning.bin||1):r=k=1,n=l.getActiveObject(),this.selectShapes(c,b,function(b,t){h=$.extend(!0,{},b.params,d);
g=a.Fabric._parseShapeOptions.call(this,c,h,b);
if(g.remove)return this.removeShapes(c,b),this;
b.set(g.opts);
b.params=$.extend(!1,{},b.params,g.params);
switch(b.params.shape){case "annulus":if(d.radii&&d.radii.length){q=b.get("stroke");
b.forEachObject(function(a){b.remove(a);
l.remove(a)});
m=b.params.radii.length;
for(e=p=0;
e<m;
e++)f=new fabric.Circle({radius:b.params.radii[e],stroke:q}),p=Math.max(p,b.params.radii[e]),b.add(f);
b.scaleX=k/r;
b.scaleY=k/r;
b.width=2*p;
b.height=2*p;
n===b&&l.setActiveObject(b)}break;
case "box":d.width&&(b.scaleX=k/r);
d.height&&(b.scaleY=k/r);
break;
case "circle":d.radius&&(b.scaleX=k/r,b.scaleY=k/r);
break;
case "ellipse":d.r1&&(b.rx=b.r1,b.scaleX=k/r,b.width=2*b.rx);
d.r2&&(b.ry=b.r2,b.scaleY=k/r,b.height=2*b.ry);
break;
case "polygon":d.points&&d.points.length&&(b.scaleX=k/r,b.scaleY=k/r),n===b&&(a.Fabric.removePolygonAnchors(j.dlayer,b),a.Fabric.addPolygonAnchors(j.dlayer,b)),a.resetPolygonCenter(b)}b.rescaleBorder();

b.setCoords();
a.Fabric._updateShape.call(s,c,b,t,"update")}),(void 0===d.redraw||d.redraw)&&l.renderAll(),this};
a.Fabric.refreshShapes=function(c){var b,d,e,f,g,h,j,l,n,m=!1,q=this;
if(n=this.getShapeLayer(c))return"main"===this.display.layers[c].dtype&&(m=!0),m?(e=this.binning.bin,f=this.primary.sect.zoom,g=this.binning.obin/this.primary.sect.ozoom*f/e,h=this.binning.obin/this.primary.sect.ozoom*f/e):(e=1,h=g=f=this.primary.sect.zoom),e=n.canvas,e.getActiveGroup()&&e.discardActiveGroup(),d=e.getActiveObject(),this.selectShapes(c,"all",function(c){b=q.logicalToDisplayPos(c.pub.lcs);
c.setLeft(b.x);
c.setTop(b.y);
switch(c.params.shape){case "point":case "text":break;
default:j=g,l=h,m&&(j*=c.scaleX,l*=c.scaleY),c.scaleX=j,c.scaleY=l,c.rescaleBorder()}c.setCoords();
switch(c.type){case "polygon":d===c&&(a.Fabric.removePolygonAnchors(n.dlayer,c),a.Fabric.addPolygonAnchors(n.dlayer,c))}}),m&&(this.binning.obin=this.binning.bin,this.primary.sect.ozoom=this.primary.sect.zoom),e&&e.renderAll(),this};
a.Fabric.addPolygonPoint=function(c,b,d){var e,f,g,h,j,l,n,m,q,p={},k,r,s,t,w,v=Number.MAX_VALUE;
if(b&&b.points){p=a.eventToDisplayPos(d);
d=b.getCenterPoint().x;
g=b.getCenterPoint().y;
d=(p.x-d)/b.get("scaleX");
k=(p.y-g)/b.get("scaleY");
for(g=-b.get("angle")*Math.PI/180;
g>2*Math.PI;
)g-=2*Math.PI;
p=Math.cos(g)*d-Math.sin(g)*k;
k=Math.sin(g)*d+Math.cos(g)*k;
d=b.points;
for(g=0;
g<d.length;
g++)f=d[g],h=d[(g+1)%d.length],j=f.x<h.x?f.x:h.x,l=f.y<h.y?f.y:h.y,n=f.x>h.x?f.x:h.x,m=f.y>h.y?f.y:h.y,e=f.x-h.x,f=f.y-h.y,q=Math.sqrt(e*e+f*f),0!==q&&(e/=q,f/=q),q=p-h.x,w=k-h.y,q=q*e+w*f,e=h.x+e*q,h=h.y+f*q,e<j?e=j:e>n&&(e=n),h<l?h=l:h>m&&(h=m),j=(e-p)*(e-p)+(h-k)*(h-k),j<v&&(v=j,r=e,s=h,t=g===d.length?0:g);
c=this.getShapeLayer(c);
a.Fabric.removePolygonAnchors(c.dlayer,b);
d.splice(t+1,0,{x:r,y:s});
c.canvas.setActiveObject(b)}};
a.Fabric.removePolygonPoint=function(c,b){var d,e,f,g;
b&&b.polyparams&&(e=b.polyparams.polygon,f=e.points,g=b.polyparams.point,d=this.getShapeLayer(c),a.Fabric.removePolygonAnchors(d.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),d.canvas.setActiveObject(e))};
a.Fabric.addPolygonAnchors=function(c,b){var d,e,f={},g=c.canvas,h=function(){var b=this.polyparams.polygon,d=this.polyparams.point,e=b.get("points"),h=c.display.image;
b.angle?f=a.rotatePoint({x:this.left,y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top);
e[d].x=(f.x-b.left)/b.scaleX;
e[d].y=(f.y-b.top)/b.scaleY;
a.resetPolygonCenter(b);
a.Fabric._updateShape.call(h,b.params.layerName,b,null,"update");
h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,!0);
g.renderAll()},j=function(b){var c,d={};
for(c=0;
c<b.params.anchors.length;
c++)d.x=b.left+b.points[c].x*b.scaleX,d.y=b.top+b.points[c].y*b.scaleY,b.angle&&(d=a.rotatePoint(d,b.angle,{x:b.left,y:b.top})),b.params.anchors[c].set({left:d.x,top:d.y,angle:b.angle}),b.params.anchors[c].setCoords();
b._calcDimensions(!0);
g.renderAll()};
if(!b.params.anchors){b.params.anchors=[];
for(d=0;
d<b.points.length;
d++)f.x=b.left+b.points[d].x*b.scaleX,f.y=b.top+b.points[d].y*b.scaleY,b.angle&&(f=a.rotatePoint(f,b.angle,b.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:b.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize,height:a.Fabric.opts.cornerSize,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=b,e.polyparams.point=d,b.params.anchors[d]=e,g.add(e);
b.on("moving",function(){j(b)});
b.on("rotating",function(){j(b)});
b.on("scaling",function(){j(b)});
b.setCoords()}};
a.Fabric.removePolygonAnchors=function(a,b){var d,e=a.canvas;
if(b.params&&b.params.anchors){for(d=0;
d<b.params.anchors.length;
d++)e.remove(b.params.anchors[d]);
delete b.params.anchors}};
a.resetPolygonCenter=function(c){var b={},d,e;
c._calcDimensions();
d=(c.minX+c.width/2)*c.scaleX;
e=(c.minY+c.height/2)*c.scaleY;
c.angle?b=a.rotatePoint({x:c.left+d,y:c.top+e},c.angle,{x:c.left,y:c.top}):(b.x=c.left+d,b.y=c.top+e);
c.left=b.x;
c.top=b.y;
c.setCoords()};
a.Fabric.print=function(){var c,b,d;
b=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));
d=this.display.canvas.toDataURL("image/png");
if(b=window.open(null,this.id,b)){b.document.open();
b.document.write("<html><body style='padding: 0px;margin: 0px' onload='window.print();return false'>");
b.document.write("<div style='position: absolute'>");
b.document.write("<img src='");
b.document.write(d);
b.document.write("' />");
b.document.write("</div>");
for(c in this.layers)this.layers.hasOwnProperty(c)&&("main"===this.layers[c].dlayer.dtype&&this.layers[c].show)&&(b.document.write("<div style='position: absolute'>"),b.document.write(this.layers[c].dlayer.canvas.toSVG()),b.document.write("</div>"));
b.document.write("</body></html>");
b.document.close()}else a.log("warning: could not create print window (check your pop-up blockers)")};
a.Fabric.initGraphics=function(){var c;
a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;
a.Image.prototype.addShapes=a.Fabric.addShapes;
a.Image.prototype.selectShapes=a.Fabric.selectShapes;
a.Image.prototype.updateShapes=a.Fabric.updateShapes;
a.Image.prototype.updateShape=a.Fabric._updateShape;
a.Image.prototype.getShapes=a.Fabric.getShapes;
a.Image.prototype.changeShapes=a.Fabric.changeShapes;
a.Image.prototype.removeShapes=a.Fabric.removeShapes;
a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;
a.Image.prototype.getShapeLayer=a.Fabric.getShapeLayer;
a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;
a.Image.prototype.displayShapeLayers=a.Fabric.displayShapeLayers;
a.Image.prototype.print=a.Fabric.print;
for(c in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(c)&&(fabric.Object.prototype[c]=a.Fabric.opts[c])};
a.Fabric.initGraphics();
a.Regions={};
a.Regions.CLASS="JS9";
a.Regions.NAME="Regions";
a.Regions.opts={canvas:{zindex:a.SHAPEZINDEX+2},panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,points:[{x:-30,y:30},{x:0,y:30},{x:30,y:30},{x:30,y:-30},{x:0,y:-30},{x:-30,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"}};
a.Regions.init=function(c){var b;
a.Image.prototype.listRegions=a.Regions.listRegions;
b=this.display.newShapeLayer(c||"regions",a.Regions.opts);
b.canvas.on("mouse:up",function(){var a,c,f=[];
if(b.display.image){c=b.display.image;
this.getActiveObject()&&f.push(this.getActiveObject());
this.getActiveGroup()&&(f=this.getActiveGroup().getObjects());

for(a=0;
a<f.length;
a++)if(f[a].params){c.params.listonchange?c.listRegions("all",!0):f[a].params.listonchange&&c.listRegions("selected",!0);
break}}});
return this};
a.Regions.initConfigForm=function(a){var b,d,e=a.params.winid,f="#"+$(e).attr("id")+" #regionsConfigForm ";
$(f+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});
$(f+".val").each(function(){d="";
b=$(this).attr("name");
switch(b){case "pts":a.pub.pts?a.pub.pts.forEach(function(a){d&&(d+=", ");
d+=sprintf("%s, %s",a.x,a.y)}):a.pub.imstr&&(d=a.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));
break;
default:void 0!==a.pub[b]&&(d=a.pub[b])}$(this).val(d)});
a.pub.wcsstr&&$(f+".wcs").removeClass("nodisplay");
void 0===a.params.listonchange&&(a.params.listonchange=!1);
a.params.listonchange?$(f+"[name='listonchange']").attr("checked","checked"):$(f+"[name='listonchange']").removeAttr("checked");
void 0===a.params.fixinplace&&(a.params.fixinplace=!1);
a.params.fixinplace?$(f+"[name='fixinplace']").attr("checked","checked"):$(f+"[name='fixinplace']").removeAttr("checked");

switch(a.pub.shape){case "box":case "ellipse":case "polygon":case "text":$(f+".angle").removeClass("nodisplay")}$(f).data("im",this);
$(f).data("shape",a);
$(f).data("winid",e)};
a.Regions.processConfigForm=function(c,b,d){var e,f,g,h=d.length,j={},l=function(a,b,c){return"remove"===b||void 0!==a.pub[b]&&String(a.pub[b])!==c||void 0!==a.params[b]&&String(a.params[b])!==c?!0:!1},n=function(a){return"true"===a?!0:"false"===a?!1:""===a||isNaN(a)?a:parseFloat(a)};
for(e=0;
e<h;
e++)switch(f=d[e].name,g=d[e].value,
f){case "x":l(c,f,g)&&(j[f]=n(g),void 0===j.y&&(j.y=c.pub.y));
break;
case "y":l(c,f,g)&&(j[f]=n(g),void 0===j.x&&(j.x=c.pub.x));
break;
default:l(c,f,g)&&(j[f]=n(g))}this.changeShapes(c.pub.layer,c,j);
a.Regions.initConfigForm.call(this,c,b)};
a.Regions.listRegions=function(a,b){var d,e,f,g,h,j="",l="none",n=!1,m=[];
void 0===b&&(b=!0);
m=this.getShapes("regions",a);
f=m.length;
if(b)for(d=0;
d<f;
d++)if(e=m[d],0<e.tags.indexOf("background")){n=!0;
break}for(d=0;
d<f;
d++)e=m[d],h=0<=e.tags.indexOf("exclude")?"-":"",n&&(g=0<=e.tags.indexOf("source")?" # source":" # bkgd"),e.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==l&&(j+=this.params.wcssys,l="wcs"),j+=";"+h+e.wcsstr):e.imstr&&(l!==e.imsys&&(j+=e.imsys,l=e.imsys),j+=";"+h+e.imstr),n&&(j+=g);
b&&this.displayMessage("regions",j);
return j};
a.Regions.keyDownCB=function(a,b,d,e){var f,g;
b={evt:d};
var h=d.which||d.keyCode;
e=e||"regions";
g=a.display.layers[e].canvas;
switch(h){case 8:case 46:d.preventDefault();
f="removeRegion";

break;
case 37:d.preventDefault();
f="editRegion";
b.dx=-1;
break;
case 38:d.preventDefault();
f="editRegion";
b.dy=1;
break;
case 39:d.preventDefault();
f="editRegion";
b.dx=1;
break;
case 40:d.preventDefault();
f="editRegion";
b.dy=-1;
break;
case 68:f="downRegion";
break;
case 85:f="upRegion"}switch(f){case "removeRegion":a.removeShapes(e,"selected");
a.clearMessage(e);
g.fire("mouse:up");
break;
case "editRegion":a.changeShapes(e,"selected",b);
g.fire("mouse:up");
break;
case "downRegion":a.selectShapes(e,"selected",function(a){g.sendToBack(a)});

break;
case "upRegion":a.selectShapes(e,"selected",function(a){g.bringToFront(a)})}};
a.Magnifier={};
a.Magnifier.CLASS="JS9";
a.Magnifier.NAME="Magnifier";
a.Magnifier.opts={originX:"left",originY:"top",hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,zoom:4,canvas:{selection:!1},tagcolors:{defcolor:"#00FF00"}};
a.Magnifier.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"x2\");return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"/2\");return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \""+a.Magnifier.opts.zoom+"\");return false'>"+a.Magnifier.opts.zoom+"</button></span>";
a.Magnifier.init=function(c,b){this.width=parseInt(this.divjq.css("width"),10);
this.width||(this.width=c||a.MAGWIDTH,this.divjq.css("width",this.width));
this.height=parseInt(this.divjq.css("height"),10);
this.height||(this.height=b||a.MAGHEIGHT,this.divjq.css("height",this.height));
this.canvas=document.createElement("canvas");
this.canvasjq=$(this.canvas);
this.canvasjq.addClass("JS9Magnifier");
this.canvasjq.css("z-index",a.ZINDEX);
this.canvasjq.attr("width",this.width);
this.canvasjq.attr("height",this.height);
this.context=this.canvas.getContext("2d");
a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);
this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);
this.display.newShapeLayer("magnifier",a.Magnifier.opts,this.divjq)};
a.Magnifier.display=function(c,b){var d,e,f,g,h,j,l,n,m,q,p,k;
c&&(c.display.pluginInstances.JS9Magnifier&&"active"===c.display.pluginInstances.JS9Magnifier.status)&&(c.magnifier||(c.magnifier={zoom:a.Magnifier.opts.zoom,posx:0,posy:0}),e=c.display.pluginInstances.JS9Magnifier,g=c.display.canvas,f=c.magnifier.zoom,l=Math.floor(e.width/f),n=Math.floor(e.height/f),b?(d=c.imageToDisplayPos(b),h=d.x-l/2,j=d.y-n/2,c.magnifier.posx=h,c.magnifier.posy=j):(h=c.magnifier.posx,j=c.magnifier.posy),q=m=0,p=e.canvas.width,k=e.canvas.height,0>h&&(l+=h,m-=h*f,p+=h*f,h=0),d=h+l-g.width,0<d&&(l-=d,p=l*f),0>j&&(n+=j,q-=j*f,k+=j*f,j=0),d=j+n-g.height,0<d&&(n-=d,k=n*f),e.context.clear(),e.context.drawImage(g,h,j,l,n,m,q,p,k),c.magnifier.boxid||(c.magnifier.boxid=c.addShapes("magnifier","box")),g=e.width/2,e=e.height/2,c.changeShapes("magnifier",c.magnifier.boxid,{left:g,top:e,width:f,height:f}))};
a.Magnifier.zoom=function(c,b){var d,e;
if(c&&c.magnifier){d=c.magnifier;
e=d.zoom;
switch(b.charAt(0)){case "x":case "*":e*=parseFloat(b.slice(1));
break;
case "/":e/=parseFloat(b.slice(1));
break;
default:e=parseFloat(b)}if(!e||1>e)e=1;
d.zoom=e;
a.Magnifier.display(c)}};
a.Magnifier.close=function(a){a.display.pluginInstances.JS9Magnifier&&a.display.pluginInstances.JS9Magnifier.context.clear()};
a.Panner={};
a.Panner.CLASS="JS9";
a.Panner.NAME="Panner";
a.Panner.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,zoom:4,canvas:{selection:!0},tagcolors:{defcolor:"#00FF00"}};
a.Panner.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"x2\");return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"/2\");return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"1\");return false'>Zoom1</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"panImage\");return false'>Center</button></span>";

a.Panner.init=function(c,b){var d,e=this;
this.width=parseInt(this.divjq.css("width"),10);
this.width||(this.width=c||a.PANWIDTH,this.divjq.css("width",this.width));
this.height=parseInt(this.divjq.css("height"),10);
this.height||(this.height=b||a.PANHEIGHT,this.divjq.css("height",this.height));
this.canvas=document.createElement("canvas");
this.canvasjq=$(this.canvas);
this.canvasjq.addClass("JS9Panner");
this.canvasjq.css("z-index",a.ZINDEX);
this.canvasjq.attr("width",this.width);
this.canvasjq.attr("height",this.height);
this.context=this.canvas.getContext("2d");
a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);
this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);
d=this.display.newShapeLayer("panner",a.Panner.opts,this.divjq);
d.canvas.on("object:modified",function(b){var c=e.display.image;
if(c){var h=b.target.getCenterPoint();
b=h.x*c.panner.xblock/c.panner.zoom+c.panner.x0-c.panner.ix;
h=(d.canvas.height-h.y)*c.panner.yblock/c.panner.zoom+c.panner.y0-c.panner.iy;
try{c.display.pluginInstances.JS9Panner.status="inactive",c.setPan(b,h)}catch(j){a.log("couldn't pan image")}finally{c.display.pluginInstances.JS9Panner.status="active"}}});
this.display.image&&a.Panner.display(this.display.image)};
a.Panner.create=function(a){var b,d,e,f,g,h,j,l,n,m,q,p,k;
if(a&&a.raw&&a.display.pluginInstances.JS9Panner&&a.psColors){a.panner||(a.panner={});
a.panner.zoom||(a.panner.zoom=1);
b=a.display.pluginInstances.JS9Panner;

d=a.panner;
e=a.primary.sect;
p=Math.min(a.raw.width,b.width);
k=Math.min(a.raw.height,b.height);
d.xblock=a.raw.width/p;
d.yblock=a.raw.height/k;
d.xblock>d.yblock?(k=k/d.xblock*d.yblock,d.yblock=d.xblock):d.yblock>d.xblock&&(p=p/d.yblock*d.xblock,d.xblock=d.yblock);
b=a.display.context.createImageData(p,k);
1===d.zoom?(h=d.xblock,j=d.yblock,e=g=0):(h=d.xblock/d.zoom,j=d.yblock/d.zoom,g=Math.max(0,(e.x0+e.x1-p*h)/2),e=Math.max(0,(e.y0+e.y1-k*j)/2));
d.x0=g;
d.y0=e;
for(l=0;
l<k;
l++){m=Math.floor(e+(k-l-1)*j)*a.raw.width;
q=l*p;
for(d=0;
d<p;
d++)f=Math.floor(g+d*h),f=a.colorData[f+m],a.psColors[f]&&(n=4*(q+d),b.data[n]=a.psColors[f][0],b.data[n+1]=a.psColors[f][1],b.data[n+2]=a.psColors[f][2],b.data[n+3]=255)}a.panner.img=b;
a.panner.ix=0;
a.panner.iy=0;
return a}};
a.Panner.display=function(c){var b,d,e,f,g,h,j;
if(c&&c.display.pluginInstances.JS9Panner&&"active"===c.display.pluginInstances.JS9Panner.status){a.Panner.create(c);
d=c.panner;
b=c.display.pluginInstances.JS9Panner;
e=c.primary.sect;
var l=c.binning.bin;

if(d.img)return d.img.width<b.canvas.width&&(d.ix=Math.floor((b.canvas.width-d.img.width)/2)),d.img.height<b.canvas.height&&(d.iy=Math.floor((b.canvas.height-d.img.height)/2)),b.context.clear(),b.context.putImageData(d.img,d.ix,d.iy),f=d.zoom/d.xblock,g=d.zoom/d.yblock,h=e.width*f/e.zoom*l,j=e.height*g/e.zoom*l,f=(e.x0-d.x0)*f+d.ix,b=b.height-1-((e.y1-d.y0)*g+d.iy),f=f+1+h/l/2,b=b+1+j/l/2,f=Math.floor(f),b=Math.floor(b),h=Math.floor(h),j=Math.floor(j),h={left:f,top:b,width:h,height:j},c.panner.boxid?c.changeShapes("panner",c.panner.boxid,h):c.panner.boxid=c.addShapes("panner","box",h),c}};
a.Panner.zoom=function(c,b){var d,e,f;
if(c&&c.panner&&c.display.pluginInstances.JS9Panner){e=c.panner;
d=c.display.pluginInstances.JS9Panner;
f=e.zoom;
switch(b.charAt(0)){case "*":case "x":case "X":d=Math.min(Math.min(d.width,d.height),f*parseFloat(b.slice(1)));
break;
case "/":d=Math.max(1,f/parseFloat(b.slice(1)));
break;
default:d=parseFloat(b)}if(!d||1>d)d=1;
e.zoom=d;
a.Panner.display(c);
return c}};
a.Panner.close=function(a){a.display.pluginInstances.JS9Panner&&a.display.pluginInstances.JS9Panner.context.clear();
return a};
a.Catalogs={};
a.Catalogs.CLASS="JS9";
a.Catalogs.NAME="Catalogs";
a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,evented:!1,canvas:{selection:!1},panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"}};
a.invoke=function(a,b){function d(){return a.apply(this,b)}var e;
d.prototype=a.prototype;

e=new d;
e.constructor=a;
return e};
"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};
b.prototype=a;
return new b});
a.getImageID=function(c,b){var d,e,f=0,g=1,h=a.images.length,j=/.*<([0-9][0-9]*)>$/;
for(d=0;
d<h;
d++)e=a.images[d],e.display.id===b&&c===e.oid&&(0<=e.id.search(j)&&(e=e.id.replace(j,"$1"),g=Math.max(g,parseInt(e,10))),f++);
return f?c+"<"+String(g+1)+">":c};
var G=1;
a.uniqueID=function(){return G++};
a.listev=function(c){c=$(c||"body")[0];
c=$.hasData(c)&&$._data(c);

a.log(c.events)};
a.waiting=function(a){switch(a){case !0:$("body").addClass("waiting");
break;
case !1:$("body").removeClass("waiting")}};
a.lightWin=function(c,b,d,e,f){switch(a.LIGHTWIN){case "dhtml":return dhtmlwindow.open(c,b,d,e,f)}};
a.checkNew=function(c){c||a.error("internal failure in a JS9 constructor")};
a.specialKey=function(a){return a.metaKey||a.ctrlKey};
a.strace=function(c){var b="";
1<a.DEBUG&&(b=c.stack||c.stacktrace||"");
return b};
a.bcall=function(c,b,d){var e,f;
(e=$(c).closest("div[class^=JS9PluginToolbar]").data("displayid"))?
f=a.getImage(e):a.error("can't find display for cmd: "+b);
f||a.error("can't find image for cmd: "+b);
switch(b){case "zoomPanner":3>arguments.length&&a.error("missing argument(s) for cmd: "+b);
try{a.Panner.zoom(f,d)}catch(g){a.error("error calling zoomPanner()",g)}break;
case "zoomMagnifier":3>arguments.length&&a.error("missing argument(s) for cmd: "+b);
try{a.Magnifier.zoom(f,d)}catch(h){a.error("error calling zoomMagnifier()",h)}break;
case "panImage":try{f.setPan()}catch(j){a.error("error calling setPan()",j)}}};
a.centroidPolygon=function(a){var b,d,e=0,f=0;
if(a&&a.length){d=a.length;
for(b=0;
b<d;
b++)e+=a[b].x,f+=a[b].y;
return{x:e/d,y:f/d}}};
a.lookupImage=function(c,b){var d,e=null,f=null,g=a.images.length;
for(d=0;
d<g;
d++)if(f=a.images[d],c===f||c===f.file||c===a.TOROOT+f.file||f.fitsFile&&c===f.fitsFile)if(0<$("#"+f.display.id).length&&(!b||b===f.display.id)){e=f;
break}return e};
a.lookupDisplay=function(c){var b,d=RegExp(sprintf("[-_]?(%s)$",a.PLUGINS));
if(c&&"*"!==c&&0>c.toString().search(a.SUPERMENU)){for(b=0;
b<a.displays.length;
b++)if(c===a.displays[b]||c===a.displays[b].id)return a.displays[b];
if("string"===typeof c){c=c.replace(d,"");
for(b=0;
b<a.displays.length;
b++)if(c===a.displays[b]||c===a.displays[b].id)return a.displays[b]}a.error("can't find JS9 display with id: "+c)}return a.displays[0]};
a.getImage=function(c){var b=null,d=null,b=a.lookupImage(c);
if(!b&&(d=a.lookupDisplay(c)))b=d.image;
return b};
a.lookupColormap=function(c){var b;
c||(c=a.imageOpts.colormap);
if(c)for(b=0;
b<a.colormaps.length;
b++)if(a.colormaps[b].name===c)return a.colormaps[b];
a.error("unknown colormap '"+c+"'")};
a.lookupCommand=function(c){var b,d;
if(c){d=c.toLowerCase();
for(b=0;
b<a.commands.length;
b++)if(c=a.commands[b],c.name===d||c.alias===d||c.alias2===d)return c}return null};
a.error=function(c,b,d){var e,f,g="",h="",j=!0;
"string"===typeof b?(f=c.match(b))?f[1]?c=f[1]:f[0]&&(c=f[0]):j=!1:"object"===typeof b&&(e=b);
3>arguments.length&&(d=!0);
if(j&&(e&&e.message?c+=sprintf(" (%s)",e.message):c&&(e=Error(c)),(f=a.strace(e))&&(h="\n\nStacktrace:\n"+f),a.globalOpts.alerts&&(c&&("string"===typeof c&&0>c.search(/ERROR/))&&(g="JS9 ERROR: "),alert(g+(c+h))),d))throw e;};
a.eventToDisplayPos=function(a){var b,d;
a||(a=window.event);
a.target?b=a.target:a.srcElement&&(b=a.srcElement);
3===b.nodeType&&(b=b.parentNode);
a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(d=a.originalEvent.changedTouches[0].pageX,a=a.originalEvent.changedTouches[0].pageY):(d=a.pageX,a=a.pageY);
d-=$(b).offset().left;
b=a-$(b).offset().top;

return{x:Math.floor(d-1),y:Math.floor(b-1)}};
a.rotatePoint=function(a,b,d){var e;
d=d||{x:0,y:0};
b=Math.PI*b/180;
e=Math.cos(b);
b=Math.sin(b);
return{x:e*(a.x-d.x)-b*(a.y-d.y)+d.x,y:b*(a.x-d.x)+e*(a.y-d.y)+d.y}};
a.log=function(){if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(a){Function.prototype.bind.call(console.log,console).apply(console,arguments)}};
a.raw2FITS=function(a,b){var d,e,f,g=!1,h="";
if(a.card)for(d=0;
d<a.card.length;
d++)h+=a.card[d],
b&&(h+="\n");
else if(a.header){d=a.header;
for(e in d)if(d.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=d[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n");
g||(h+=sprintf("%-8s%-72s","END"," "),b&&(h+="\n"))}return h};
CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));
this.clearRect(0,0,this.canvas.width,this.canvas.height);
a&&this.restore()};
a.xeqByName=function(c,b){var d,e,f,g;
e=Array.prototype.slice.call(arguments,2);
d=typeof c;
switch(d){case "function":return c.apply(b,e);
case "string":f=c.split(".");
g=f.pop();
for(d=0;
d<f.length;
d++)b=b[f[d]];
return b[g].apply(b,e);
default:a.error("unknown function type: "+d)}};
a.loadPrefs=function(c,b){$.ajax({url:c,dataType:"json",async:!1,success:function(b){var c,f,g;
for(g in b)if(b.hasOwnProperty(g)&&a.hasOwnProperty(g)&&(f=typeof a[g],c=typeof b[g],f===c||"string"===c))switch(f){case "object":$.isArray(b[g])?a[g]=b[g]:$.extend(!0,a[g],b[g]);
break;
case "number":case "string":a[g]=b[g]}},error:function(){b&&("Chrome"===a.BROWSER[0]&&""===document.domain?a.log("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file."):a.log("JS9 prefs file not available: %s",c))}})};
a.isTypedArray=function(a){a=Object.prototype.toString.call(a);
return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};
a.mouseDownCB=function(c){var b,d,e,f,g=c.data,h=g.image;
c.preventDefault();
if(h)if(2<a.DEBUG&&a.log("m-down: %d %d %d %s",c.clientX-g.x,c.clientY-g.y,h.evstate,h.rclick),d=a.eventToDisplayPos(c),f=h.displayToImagePos(d),h.dnpos=d,h.rclick)h.clearMessage("regions");
else{if(!a.specialKey(c))for(b in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&(d=g.pluginInstances[b],e=d.plugin.opts,d.isActive("onmousedown")&&(!h.rclick||e.mousedownRegions)))try{e.onmousedown.call(d,h,f,c.originalEvent||c)}catch(j){d.errLog("onmousedown",j)}h.evstate=c.button;
c.originalEvent&&(c.originalEvent.touches&&c.originalEvent.touches.length)&&(h.evstate=c.originalEvent.touches.length-2);
$("body").on("mousemove",g,function(b){return a.mouseMoveCB(b)});
$("body").on("mouseup",g,function(b){return a.mouseUpCB(b)})}};
a.mouseUpCB=function(c){var b,d,e,f,g=c.data,h=g.image;

c.preventDefault();
if(h){b=a.eventToDisplayPos(c);
d=h.displayToImagePos(b);
h.rclick?h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-b.y)<a.NOMOVE?h.updateShapes("regions","selected","select"):h.updateShapes("regions","selected","update"):a.specialKey(c)&&(h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-b.y)<a.NOMOVE)&&h.setPan(d.x,d.y);
if(!a.specialKey(c))for(e in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&(b=g.pluginInstances[e],f=b.plugin.opts,b.isActive("onmouseup")&&(!h.rclick||f.mouseupRegions)))try{f.onmouseup.call(b,h,d,c.originalEvent||c)}catch(j){b.errLog("onmouseup",j)}h.rclick=0;
h.evstate=-1;
$("body").off("mouseup");
$("body").off("mousemove");
2<a.DEBUG&&a.log("m-up: %d %d %s",c.clientX-g.x,c.clientY-g.y,h.rclick)}};
a.mouseMoveCB=function(c){var b,d,e,f,g=c.data,h=g.image;
c.preventDefault();
if(h){b=a.eventToDisplayPos(c);
d=h.displayToImagePos(b);
h.valpos=null;
3<a.DEBUG&&a.log("m-move: %d %d %s %s",c.clientX-g.x,c.clientY-g.y,h.rclick,h.evstate);
if(h.rclick&&
(h.rclick=2,(f=h.display.layers.regions.params.sel)&&(h.params.listonchange||f.params.listonchange)))h.updateShape("regions",f,null,"update",!0),h.listRegions("selected",!0);
switch(h.evstate){case -1:if(0<d.x&&(0<d.y&&d.x<h.raw.width&&d.y<h.raw.height)&&!a.specialKey(c))for(e in a.globalOpts.internalValPos&&(h.valpos=h.updateValpos(d)),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&(b=g.pluginInstances[e],f=b.plugin.opts,b.isActive("onmousemove")&&(!h.rclick||f.mousemoveRegions)))try{f.onmousemove.call(b,h,d,c.originalEvent||c)}catch(j){b.errLog("onmousemove",j)}break;
case 0:case 1:if(h.rclick||a.specialKey(c))break;
if(h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-b.y)<a.NOMOVE)break;
d.x=Math.floor(b.x+0.5);
d.y=Math.floor(b.y+0.5);
if(0>d.x||0>d.y||d.x>=g.canvas.width||d.y>=g.canvas.height)break;
h.params.bias=d.x/g.canvas.width;
h.params.contrast=10*(d.y/g.canvas.height);
a.bugs.firefox_linux?window.setTimeout(function(){h.displayImage("scaled")},0):h.displayImage("scaled")}}};
a.mouseOverCB=function(c){var b,d,e,f,g=c.data,h=g.image;
c.preventDefault();
if(h&&(h.display.displayConjq.focus(),!a.specialKey(c)))for(d in b=a.eventToDisplayPos(c),b=h.displayToImagePos(b),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(d)&&(e=g.pluginInstances[d],f=e.plugin.opts,e.isActive("onmouseover")&&(!h.rclick||f.mouseoverRegions)))try{f.onmouseover.call(e,h,b,c.originalEvent||c)}catch(j){e.errLog("onmouseover",j)}};
a.mouseOutCB=function(c){var b,d,e,f,g=c.data,h=g.image;
c.preventDefault();
if(h&&(h.display.displayConjq.blur(),!a.specialKey(c)))for(d in b=a.eventToDisplayPos(c),b=h.displayToImagePos(b),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(d)&&(e=g.pluginInstances[d],f=e.plugin.opts,e.isActive("onmouseout")&&(!h.rclick||f.mouseoutRegions)))try{f.onmouseout.call(e,h,b,c.originalEvent||c)}catch(j){e.errLog("onmouseout",j)}};
a.keyPressCB=function(c){var b,d,e,f,g=c.data,h=g.image;
b=c.which||c.keyCode;
c.preventDefault();
3<a.DEBUG&&a.log("keypress: %d ",b);
b=a.eventToDisplayPos(c);

b=h.displayToImagePos(b);
for(d in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(d)&&(e=g.pluginInstances[d],f=e.plugin.opts,e.isActive("onkeypress")))try{f.onkeypress.call(e,h,b,c.originalEvent||c)}catch(j){e.errLog("onkeypress",j)}};
a.keyDownCB=function(c){var b,d,e,f,g=c.data,h=g.image;
b=c.which||c.keyCode;
3<a.DEBUG&&a.log("keydown: %d ",b);
b=a.eventToDisplayPos(c);
b=h.displayToImagePos(b);
for(d in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(d)&&(e=g.pluginInstances[d],f=e.plugin.opts,e.isActive("onkeydown")))try{f.onkeydown.call(e,h,b,c.originalEvent||c)}catch(j){e.errLog("onkeydown",j)}h.layer&&h.layers[h.layer].opts.usekeyboard&&a.Regions.keyDownCB(h,b,c,h.layer)};
a.consoleKeyDownCB=function(c){var b=c.data,d=c.which||c.keyCode;
if(!a.specialKey(c)){c=b.consoleConjq.find(".JS9CmdIn:last");
c.focus();
if(b.hist.length&&(38===d||40===d)){b.hist[b.histpos]?b.hist[b.histpos]=c.val():b.histtemp=c.val();
switch(d){case 38:b.histpos--;
0>b.histpos&&(b.histpos=0);
break;
case 40:b.histpos++;

b.histpos>b.hist.length&&(b.histpos=b.hist.length);
break;
default:a.error("internal keycode switch mixup")}b.hist[b.histpos]?(c.val(b.hist[b.histpos]),b.histused=b.histpos!==b.hist.length?!0:!1):(c.val(b.histtemp),b.histused=!1)}13===d&&(a.globalOpts.alerts=!1,b.xeq(),a.globalOpts.alerts=!0,b.inp())}};
a.RegisterPlugin=function(c,b,d,e){var f;
if(c&&(b&&d)&&(f=c+b,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.plugins.push({xclass:c,xname:b,name:f,opts:e,func:d,instances:[]}),e.help)){var g;d=e.help.match(/^.*[\\\/]/);
d[0]&&(g="plugins/"+d[0].replace(/[\\\/]+$/,""));
d=e.help.replace(/^.*[\\\/]/,"");
a.helpOpts[b]={type:g,url:d,heading:c,title:e.menuItem?e.menuItem:f}}};
a.instantiatePlugin=function(c,b,d,e){var f,g,h;
if("string"===typeof b){for(f=0;
f<a.plugins.length;
f++)if(g=a.plugins[f],g.name===b){b=g;
break}"string"===typeof b&&a.error("unknown plugin: "+b)}g=Object.create(b.func.prototype);
g.name=b.name;
g.isActive=function(a){if("active"!==this.status||!this.plugin.opts.hasOwnProperty(a))return!1;
switch(this.winType){case "virtual":return!0;
default:return this.divjq.is(":visible")}};
g.errLog=function(b,d){a.log("error in %s: %s [%s]\n%s",b,this.name,d.message,a.strace(d))};
if(c){h=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c);
for(f=0;
f<b.instances.length;
f++)if(h.is(b.instances[f].odivjq))return b.instances[f]}else h=$("div");
if(c)if(d)g.id=
h.attr("id")||b.name,g.winType="light",g.winHandle=d,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top);
else{if(g.id=h.attr("id")||b.name,g.winType="div",d=h.attr("id")||"JS9Plugin",h.wrap("<div class='JS9PluginContainer'>"),g.odivjq=h,g.divjq=h,g.divjq.addClass(b.xclass+"Plugin").addClass("JS9Plugin"),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),b.opts.toolbarSeparate||h.data("toolbarseparate"))d="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+"'>",$(d).insertBefore(g.divjq)}else g.id=b.name,g.winType="virtual";
g.plugin=b;
g.el=c;
g.status="active";
b.instances.push(g);
if("virtual"===g.winType)for(f=0;
f<a.displays.length;
f++)a.displays[f].pluginInstances[b.name]||(g.div=null,g.display=a.displays[f],b.func.apply(g,e),a.displays[f].pluginInstances[b.name]=g);
else{g.div=g.divjq[0];
g.outerdiv=g.outerdivjq[0];
if(b.opts.winDims&&(!g.divjq.width()||!g.divjq.height()))g.divjq.css("width",b.opts.winDims[0]),g.divjq.css("height",b.opts.winDims[1]);
d=g.divjq.data("js9id")||g.id;
g.display=a.lookupDisplay(d);

if(h=h.data("toolbarhtml")||b.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:b.opts.winTitle||""}]),c=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===c.length&&(c=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(c);
g.display.pluginInstances[b.name]=g;
b.func.apply(g,e)}return g};
a.instantiatePlugins=function(){var c,b=function(b){$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});
!b.opts.menuItem&&(b.opts.winDims&&!b.opts.winDims[0]&&!b.opts.winDims[1])&&a.instantiatePlugin(null,b,null,b.opts.divArgs)};
for(c=0;
c<a.plugins.length;
c++)b(a.plugins[c])};
a.init=function(){window.HTMLCanvasElement||a.error("sorry: your browser does not support JS9 (no HTML5 canvas support). Try a modern version of Firefox, Chrome, or Safari.");
JSON||a.error("sorry: your browser does not support JS9 (no JSON support). Try a modern version of Firefox, Chrome, or Safari.");

if(!a.INSTALLDIR){try{a.INSTALLDIR=$('link[href$="js9.css"]').attr("href").replace(/js9\.css$/,"")||""}catch(c){a.INSTALLDIR=""}a.TOROOT=a.INSTALLDIR.replace(/([^\/.])+/g,"..")}window.hasOwnProperty("Kinetic")&&!window.hasOwnProperty("fabric")&&a.error("please load fabric.js instead of Kinetic.js");
"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),$("#dhtmlwindowholder").bind("DOMNodeInserted",function(b){var d=a.globalOpts.dhtmlonload,c=a.globalOpts.dhtmlloadid;
d&&c===$(b.target).attr("id")&&(delete a.globalOpts.dhtmlonload,delete a.globalOpts.dhtmlloadid,window.setTimeout(function(){d.call(null)},a.TIMEOUT))}),dhtmlwindow.imagefiles=[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")]);
a.loadPrefs(a.InstallDir(a.PREFSFILE),1);
a.loadPrefs(a.PREFSFILE,0);
a.DEBUG=a.DEBUG||a.globalOpts.debug||0;
$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});

a.RegisterPlugin("JS9","Menubar",a.Menubar);
a.RegisterPlugin("JS9","Info",a.Info.init,{menuItem:"InfoBox",plugindisplay:a.Info.clearMain,winTitle:"JS9 Info",winResize:!0,winDims:[a.INFOWIDTH,a.INFOHEIGHT]});
a.RegisterPlugin("JS9","Console",a.Console,{menuItem:"Console",winTitle:"JS9 Console",winResize:!0,winDims:[a.WIDTH,180]});
a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{onkeydown:a.Regions.keyDownCB,divArgs:["regions"],winDims:[0,0]});
a.RegisterPlugin(a.Magnifier.CLASS,a.Magnifier.NAME,a.Magnifier.init,{menuItem:"Magnifier",toolbarSeparate:!1,toolbarHTML:a.Magnifier.HTML,onmousemove:a.Magnifier.display,onimageclose:a.Magnifier.close,winTitle:"JS9 Magnifier",winDims:[a.MAGWIDTH,a.MAGHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});a.RegisterPlugin(a.Panner.CLASS,a.Panner.NAME,a.Panner.init,{menuItem:"Panner",toolbarSeparate:!1,toolbarHTML:a.Panner.HTML,onimagedisplay:a.Panner.display,onimageclose:a.Panner.close,winTitle:"JS9 Panner",winDims:[a.PANWIDTH,a.PANHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});
a.instantiatePlugins();
a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]));
a.checkNew(new a.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]]));
a.checkNew(new a.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]]));
a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]]));
a.checkNew(new a.Colormap("a",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.77,0],[1,1]],[[0,0],[0.125,0],[0.5,1],[0.64,0.5],[0.77,0],[1,0]]));

a.checkNew(new a.Colormap("b",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.5,0],[0.75,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.75,0],[1,1]]));
a.checkNew(new a.Colormap("bb",[[0,0],[0.5,1],[1,1]],[[0,0],[0.25,0],[0.75,1],[1,1]],[[0,0],[0.5,0],[1,1]]));
a.checkNew(new a.Colormap("he",[[0,0],[0.015,0.5],[0.25,0.5],[0.5,0.75],[1,1]],[[0,0],[0.065,0],[0.125,0.5],[0.25,0.75],[0.5,0.81],[1,1]],[[0,0],[0.015,0.125],[0.03,0.375],[0.065,0.625],[0.25,0.25],[1,1]]));
a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,
0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]]));
a.checkNew(new a.Colormap("aips0",[[0.196,0.196,0.196],[0.475,0,0.608],[0,0,0.785],[0.373,0.655,0.925],[0,0.596,0],[0,0.965,0],[1,1,0],[1,0.694,0],[1,0,0]]));
a.checkNew(new a.Colormap("sls",[[0,0,0],[0.043442,0,0.052883],[0.086883,0,0.105767],[0.130325,0,0.15865],[0.173767,0,0.211533],[0.217208,0,0.264417],[0.26065,0,0.3173],[0.304092,0,0.370183],[0.347533,0,0.423067],[0.390975,0,0.47595],[0.434417,0,0.528833],[0.477858,0,0.581717],[0.5213,0,0.6346],
[0.506742,0,0.640217],[0.492183,0,0.645833],[0.477625,0,0.65145],[0.463067,0,0.657067],[0.448508,0,0.662683],[0.43395,0,0.6683],[0.419392,0,0.673917],[0.404833,0,0.679533],[0.390275,0,0.68515],[0.375717,0,0.690767],[0.361158,0,0.696383],[0.3466,0,0.702],[0.317717,0,0.712192],[0.288833,0,0.722383],[0.25995,0,0.732575],[0.231067,0,0.742767],[0.202183,0,0.752958],[0.1733,0,0.76315],[0.144417,0,0.773342],[0.115533,0,0.783533],[0.08665,0,0.793725],[0.057767,0,0.803917],[0.028883,0,0.814108],[0,0,0.8243],
[0,0.019817,0.838942],[0,0.039633,0.853583],[0,0.05945,0.868225],[0,0.079267,0.882867],[0,0.099083,0.897508],[0,0.1189,0.91215],[0,0.138717,0.926792],[0,0.158533,0.941433],[0,0.17835,0.956075],[0,0.198167,0.970717],[0,0.217983,0.985358],[0,0.2378,1],[0,0.268533,1],[0,0.299267,1],[0,0.33,1],[0,0.360733,1],[0,0.391467,1],[0,0.4222,1],[0,0.452933,1],[0,0.483667,1],[0,0.5144,1],[0,0.545133,1],[0,0.575867,1],[0,0.6066,1],[0,0.631733,0.9753],[0,0.656867,0.9506],[0,0.682,0.9259],[0,0.707133,0.9012],[0,0.732267,
0.8765],[0,0.7574,0.8518],[0,0.782533,0.8271],[0,0.807667,0.8024],[0,0.8328,0.7777],[0,0.857933,0.753],[0,0.883067,0.7283],[0,0.9082,0.7036],[0,0.901908,0.676675],[0,0.895617,0.64975],[0,0.889325,0.622825],[0,0.883033,0.5959],[0,0.876742,0.568975],[0,0.87045,0.54205],[0,0.864158,0.515125],[0,0.857867,0.4882],[0,0.851575,0.461275],[0,0.845283,0.43435],[0,0.838992,0.407425],[0,0.8327,0.3805],[0,0.832308,0.354858],[0,0.831917,0.329217],[0,0.831525,0.303575],[0,0.831133,0.277933],[0,0.830742,0.252292],
[0,0.83035,0.22665],[0,0.829958,0.201008],[0,0.829567,0.175367],[0,0.829175,0.149725],[0,0.828783,0.124083],[0,0.828392,0.098442],[0,0.828,0.0728],[0.033167,0.834167,0.066733],[0.066333,0.840333,0.060667],[0.0995,0.8465,0.0546],[0.132667,0.852667,0.048533],[0.165833,0.858833,0.042467],[0.199,0.865,0.0364],[0.232167,0.871167,0.030333],[0.265333,0.877333,0.024267],[0.2985,0.8835,0.0182],[0.331667,0.889667,0.012133],[0.364833,0.895833,0.006067],[0.398,0.902,0],[0.43095,0.902,0],[0.4639,0.902,0],[0.49685,
0.902,0],[0.5298,0.902,0],[0.56275,0.902,0],[0.5957,0.902,0],[0.62865,0.902,0],[0.6616,0.902,0],[0.69455,0.902,0],[0.7275,0.902,0],[0.76045,0.902,0],[0.7934,0.902,0],[0.810617,0.897133,0.003983],[0.827833,0.892267,0.007967],[0.84505,0.8874,0.01195],[0.862267,0.882533,0.015933],[0.879483,0.877667,0.019917],[0.8967,0.8728,0.0239],[0.913917,0.867933,0.027883],[0.931133,0.863067,0.031867],[0.94835,0.8582,0.03585],[0.965567,0.853333,0.039833],[0.982783,0.848467,0.043817],[1,0.8436,0.0478],[0.995725,0.824892,
0.0516],[0.99145,0.806183,0.0554],[0.987175,0.787475,0.0592],[0.9829,0.768767,0.063],[0.978625,0.750058,0.0668],[0.97435,0.73135,0.0706],[0.970075,0.712642,0.0744],[0.9658,0.693933,0.0782],[0.961525,0.675225,0.082],[0.95725,0.656517,0.0858],[0.952975,0.637808,0.0896],[0.9487,0.6191,0.0934],[0.952975,0.600408,0.085617],[0.95725,0.581717,0.077833],[0.961525,0.563025,0.07005],[0.9658,0.544333,0.062267],[0.970075,0.525642,0.054483],[0.97435,0.50695,0.0467],[0.978625,0.488258,0.038917],[0.9829,0.469567,
0.031133],[0.987175,0.450875,0.02335],[0.99145,0.432183,0.015567],[0.995725,0.413492,0.007783],[1,0.3948,0],[0.998342,0.3619,0],[0.996683,0.329,0],[0.995025,0.2961,0],[0.993367,0.2632,0],[0.991708,0.2303,0],[0.99005,0.1974,0],[0.988392,0.1645,0],[0.986733,0.1316,0],[0.985075,0.0987,0],[0.983417,0.0658,0],[0.981758,0.0329,0],[0.9801,0,0],[0.955925,0,0],[0.93175,0,0],[0.907575,0,0],[0.8834,0,0],[0.859225,0,0],[0.83505,0,0],[0.810875,0,0],[0.7867,0,0],[0.762525,0,0],[0.73835,0,0],[0.714175,0,0],[0.69,
0,0],[0.715833,0.083333,0.083333],[0.741667,0.166667,0.166667],[0.7675,0.25,0.25],[0.793333,0.333333,0.333333],[0.819167,0.416667,0.416667],[0.845,0.5,0.5],[0.870833,0.583333,0.583333],[0.896667,0.666667,0.666667],[0.9225,0.75,0.75],[0.948333,0.833333,0.833333],[0.974167,0.916667,0.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]]));
a.checkNew(new a.Colormap("hsv",function(){var a,d,c,f,g,h,j,l=[],n=0;
for(a=0;
200>a;
a++,n++){d=1-a/199;
c=360*d+270;
f=Math.abs(Math.sin(3.1416*d));

for(d=Math.pow(1-d,1/3);
360<=c;
)c-=360;
c/=60;
j=Math.floor(c);
g=c-j;
c=d*(1-f);
h=d*(1-f*g);
f=d*(1-f*(1-g));
l[n]=[];
switch(j){case 0:l[n].push(d);
l[n].push(f);
l[n].push(c);
break;
case 1:l[n].push(h);
l[n].push(d);
l[n].push(c);
break;
case 2:l[n].push(c);
l[n].push(d);
l[n].push(f);
break;
case 3:l[n].push(c);
l[n].push(h);
l[n].push(d);
break;
case 4:l[n].push(f);
l[n].push(c);
l[n].push(d);
break;
case 5:l[n].push(d),l[n].push(c),l[n].push(h)}}return l}()));
a.checkNew(new a.Colormap("heat",[[0,0],[0.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[0.65,0],[0.98,1],[1,1]]));
a.checkNew(new a.Colormap("cool",[[0,0],[0.29,0],[0.76,0.1],[1,1]],[[0,0],[0.22,0],[0.96,1],[1,1]],[[0,0],[0.53,1],[1,1]]));
a.checkNew(new a.Colormap("rainbow",[[0,1],[0.2,0],[0.6,0],[0.8,1],[1,1]],[[0,0],[0.2,0],[0.4,1],[0.8,1],[1,0]],[[0,1],[0.4,1],[0.6,0],[1,0]]));
a.checkNew(new a.Colormap("standard",[[0,0],[0.333,0.3],[0.333,0],[0.666,0.3],[0.666,0.3],[1,1]],[[0,0],[0.333,0.3],[0.333,0.3],[0.666,1],[0.666,0],[1,0.3]],[[0,0],[0.333,1],[0.333,0],[0.666,0.3],[0.666,0],[1,0.3]]));
a.checkNew(new a.Colormap("staircase",function(){var a,d,c=[],f=0;
for(a=1;
5>=a;
a++,f++)d=a/5,c[f]=[],c[f].push(0.3*d),c[f].push(0.3*d),c[f].push(d);
for(a=1;
5>=a;
a++,f++)d=a/5,c[f]=[],c[f].push(0.3*d),c[f].push(d),c[f].push(0.3*d);
for(a=1;
5>=a;
a++,f++)d=a/5,c[f]=[],c[f].push(d),c[f].push(0.3*d),c[f].push(0.3*d);
return c}()));
a.checkNew(new a.Colormap("color",[[0,0,0],[0.18431,0.18431,0.18431],[0.37255,0.37255,0.37255],[0.56078,0.56078,0.56078],[0.74902,0.74902,0.74902],[0.93725,0.93725,0.93725],[0,0.18431,0.93725],[0,0.37255,0.74902],[0,0.49804,0.49804],[0,0.74902,0.3098],[0,0.93725,0],[0.3098,0.62353,0],[0.49804,0.49804,0],[0.62353,0.3098,0],[0.93725,0,0],[0.74902,0,0.3098]]));
a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,d,c,f,g,h="",j=this.image;
if(j&&j.analysisPackages)for(d=0;
d<j.analysisPackages.length;
d++){g=j.analysisPackages[d];
for(a=0;
a<g.length;
a++)f=g[a],h&&(h+=", "),c=f.xclass?f.xclass+":"+f.name:f.name,h+=sprintf("%s (%s)",f.title,c);
d<j.analysisPackages.length-1&&(h+="\n")}return h},set:function(b){var d,c=this.image;
c&&((d=c.lookupAnalysis(b[0]))?d.purl?(b=c.displayAnalysis("params",a.InstallDir(d.purl),d.title+": "+c.fitsFile),$(b).data("dispid",c.display.id).data("aname",d.name)):c.runAnalysis(d.name):a.error("unknown analysis command '"+b[0]+"'"))}}));
a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;
if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,a.bias)},set:function(a){var d=this.image;
d&&d.setColormap.apply(d,a)}}));
a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var b,d="";
for(b=0;
b<a.colormaps.length;
b++)d&&(d+=", "),d+=a.colormaps[b].name;
return d}}));
a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var b,d,c;
c="<table>";
for(b=0;
b<a.commands.length;
b++)d=
a.commands[b],c+="<tr><td>"+d.name+"</td><td>"+d.help,d.alias&&(c+=" ("+d.alias,d.alias2&&(c+=", "+d.alias2),c+=")"),c+="</td></tr>";
return c+"</table>"}}));
a.checkNew(new a.Command({name:"helper",help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(b){a.helper.connect(b[0].trim())}}));
a.checkNew(new a.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;
if(a)return a.file},set:function(b){var c,e;
for(c=0;
c<a.images.length;
c++)if(e=a.images[c],0<=e.file.search(b[0])&&e.display===this.display){e.displayImage("display");
break}}}));
a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",get:function(){var b,c,e="";
for(b=0;
b<a.images.length;
b++)c=a.images[b],c.display===this.display&&(e&&(e+=", "),e+=c.file);
return e}}));
a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(b){var c;
for(c=0;
c<b.length;
c++)a.Load(b[c],{display:this.display.id})}}));

a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;
if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var c=this.image;
c&&c.setPan.apply(c,a)}}));
a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(b){var c=this.image;
if(c)return b=a.Pix2WCS(c,b[0],b[1]),b.str}}));
a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;
a&&a.print()}}));
a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;
if(a)return a.listRegions("all",!1)||""},set:function(b){var c,e,f=this.image;
if(f){if(1<b.length)try{c=b.slice(1).join(" "),e=JSON.parse(c)}catch(g){a.error("bad json format for region params: "+c,g)}f.addShapes("regions",b[0],e)}}}));
a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;

if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},set:function(a){var c=this.image;
c&&c.setScale.apply(c,a)}}));
a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}}));
a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",get:function(b){var c,e,f,g="";
for(c=0;
c<a.images.length;
c++)if(e=a.images[c],0<=e.file.search(b[0])){f=e;
break}f?c=1:(c=0,f=this.image);

if(f){if(c>b.length)return f.status.load;
for(;
c<b.length;
c++)switch(e=b[c].toLowerCase().trim(),e){case "load":g&&(g+="\n"),g+=f.status.load}}return g}}));
a.checkNew(new a.Command({name:"url",help:"display a url",set:function(b){a.DisplayHelp(b[0])}}));
a.checkNew(new a.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var a=this.image;
if(a)return a.getWCSSys()},set:function(a){var c=this.image;
c&&c.setWCSSys(a[0])}}));
a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",
get:function(){var a=this.image;
if(a)return a.getWCSUnits()},set:function(a){var c=this.image;
c&&c.setWCSUnits(a[0])}}));
a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}}));
a.checkNew(new a.Command({name:"wcsunits",help:"get list of available wcs units",get:function(){return a.wcsunitss.join(", ")}}));
a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(b){var c=this.image;

if(c)return b=a.WCS2Pix(c,b[0],b[1]),b.str}}));
a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;
if(a)return a.getZoom()},set:function(a){var c=this.image;
c&&c.setZoom(a[0])}}));
a.helper=new a.Helper;
window.hasOwnProperty("Fitsy")&&Fitsy.datahandler(a.Load);
window.hasOwnProperty("Astroem")&&(a.initwcs=Astroem.initwcs,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.zscale=Astroem.zscale);
$(document).on("keyup keypress",".js9AnalysisForm",function(a){if(13===(a.keyCode||a.which))return a.preventDefault(),!1});
$(document).scrollTop(0)};
a.parsePublicArgs=function(a){var b=null;
a=Array.prototype.slice.call(a);
var d=a[a.length-1];
d&&("object"===typeof d&&d.hasOwnProperty("display")&&1===Object.keys(d).length)&&(b=d.display,a.pop());
return{argv:a,display:b}};
a.mkPublic=function(c,b){"string"===typeof b?a.Image.prototype[b]?(a[c]=function(){var c;

c=a.parsePublicArgs(arguments);
var e=a.getImage(c.display);
if(e)return c=e[b].apply(e,c.argv),c===e?"OK":c},a.publics[c]=a[c]):a.error("unknown image function for mkPublic: "+b):"function"===typeof b?(a[c]=b,a.publics[c]=a[c]):a.error("unsupported type for mkPublic: "+typeof b)};
a.mkPublic("CloseImage","closeImage");
a.mkPublic("DisplayImage","displayImage");
a.mkPublic("GetColormap","getColormap");
a.mkPublic("SetColormap","setColormap");
a.mkPublic("GetZoom","getZoom");
a.mkPublic("SetZoom","setZoom");

a.mkPublic("GetPan","getPan");
a.mkPublic("SetPan","setPan");
a.mkPublic("GetScale","getScale");
a.mkPublic("SetScale","setScale");
a.mkPublic("GetValPos","updateValpos");
a.mkPublic("ImageToDisplayPos","imageToDisplayPos");
a.mkPublic("DisplayToImagePos","displayToImagePos");
a.mkPublic("ImageToLogicalPos","imageToLogicalPos");
a.mkPublic("LogicalToImagePos","logicalToImagePos");
a.mkPublic("GetWCSUnits","getWCSUnits");
a.mkPublic("SetWCSUnits","setWCSUnits");
a.mkPublic("GetWCSSys","getWCSSys");
a.mkPublic("SetWCSSys",
"setWCSSys");
a.mkPublic("ShowShapeLayer","showShapeLayer");
a.mkPublic("AddShapes","addShapes");
a.mkPublic("RemoveShapes","removeShapes");
a.mkPublic("GetShapes","getShapes");
a.mkPublic("ChangeShapes","changeShapes");
a.mkPublic("Print","print");
a.mkPublic("RunAnalysis","runAnalysis");
a.mkPublic("Load",function(c,b){var d,e,f;
d=a.parsePublicArgs(arguments);
if(c)if(d=d.display?d.display:0<a.displays.length?a.displays[0].id:a.DEFID,b=b||{},b.display=b.display||d,b.onload?e=b.onload:a.imageOpts.onload&&(e=a.imageOpts.onload,b.onload=e),c instanceof Blob){if(c.name){if(d=a.lookupImage(c.name,d)){d.displayImage("display");
d.clearMessage();
return}b.filename=c.name}b.filename||(b.filename=a.ANON);
c.name=b.filename;
Fitsy.handleFITSFile(c,b,a.NewFitsImage)}else if("object"===typeof c)a.checkNew(new a.Image(c,b,e));
else if("string"!==typeof c&&a.error("unknown file type for Load: "+typeof c),"U0lNUExFICA9"===c.slice(0,12)&&(c=window.atob(c)),"SIMPLE  ="===c.slice(0,9)){f=[];
for(d=0;
d<c.length;
d++)f[d]=
c.charCodeAt(d);
d=new Blob([new Uint8Array(f)]);
b.filename||(b.filename=a.ANON);
d.name=b.filename;
Fitsy.handleFITSFile(d,b,a.NewFitsImage)}else(d=a.lookupImage(c,d))?(d.displayImage("display"),d.clearMessage()):(c=c.trim(),d=c.split(".").pop().toLowerCase(),"png"===d?a.globalOpts.pngisfits?a.checkNew(new a.Image(c,b,e)):window.hasOwnProperty("Fitsy")?(a.waiting(!0),Fitsy.fetchURL(null,c,b,a.NewFitsImage)):a.error("no FITS module available to load this png: "+c):b.fits2png||void 0===b.fits2png&&a.globalOpts.fits2png?a.helper.connected?a.helper.send("fits2png",{fits:c},function(c){var d;
c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};
c.stderr&&a.error(c.stderr,a.analOpts.epattern);
c.stdout&&(c=c.stdout.replace(/\n*$/,"").split("\n").pop(),d=c.split(".").pop().toLowerCase(),"png"===d?a.checkNew(new a.Image(c,b,e)):a.error("fits2png conversion failed: "+c))}):a.error("no helper available to convert this image: "+c):window.hasOwnProperty("Fitsy")?(a.waiting(!0),Fitsy.fetchURL(c,c,b,a.NewFitsImage)):a.error("no FITS module available to load this image: "+c));
else a.error("JS9.Load: no file specified for image load")});
a.mkPublic("LoadWindow",function(c,b,d,e,f){var g;
switch(d){case "light":d="lite"+a.uniqueID();
g="d"+d;
e=e||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",d,d);
f=f||a.lightOpts[a.LIGHTWIN].imageWin;
a.lightWin(g,"inline",e,c,f);
a.checkNew(new a.Display(d));
a.instantiatePlugins();
b.display=d;
a.Load(c,b);
break;

case "new":d="new"+a.uniqueID(),f=document.getElementsByTagName("head")[0].innerHTML,f+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script"),e=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",d,d),e=sprintf("<html><head>%s</head><body onload='JS9.Preload(\"%s\",%s);'>%s</body></html>",f,c,JSON.stringify(b),e),c=window.open(null,d,"width=540, height=560"),c=c.document,c.open(),c.write(e),c.close()}});
a.mkPublic("Preload",function(c){var b,d,e="",f=null,g=arguments.length;
b=a.parsePublicArgs(arguments);
b.display&&(f={display:b.display},g-=1);
switch(g){case 0:b=(null===a.helper.connected||a.helper.connected)&&0<a.preloads.length?2:3;
break;
case 1:b="boolean"===typeof c?0<a.preloads.length?2:3:null===a.helper.connected||a.helper.connected?1:0;
break;
default:b=null===a.helper.connected||a.helper.connected?1:0}switch(b){case 0:for(b=0;
b<g;
b++)d=b+1,d<g&&"object"===typeof arguments[d]?(a.preloads.push([arguments[b],arguments[d],f]),b++):a.preloads.push([arguments[b],null,f]);
break;
case 1:a.globalOpts.alerts=!1;
for(b=0;
b<g;
b++)if(d=b+1,d<g&&"object"===typeof arguments[d]){try{f?a.Load(arguments[b],arguments[d],f):a.Load(arguments[b],arguments[d])}catch(h){e=e+" "+arguments[b]}b++}else try{f?a.Load(arguments[b],null,f):a.Load(arguments[b],null)}catch(j){e=e+" "+arguments[b]}a.globalOpts.alerts=!0;
e&&alert("could not preload image(s): "+e);
break;
case 2:a.globalOpts.alerts=!1;
for(b=0;
b<a.preloads.length;
b++)try{a.preloads[b][2]?a.Load(a.preloads[b][0],a.preloads[b][1],a.preloads[b][2]):a.Load(a.preloads[b][0],a.preloads[b][1])}catch(l){e=e+" "+a.preloads[b][0]}a.globalOpts.alerts=!0;
e&&alert("could not preload image(s): "+e)}});
a.mkPublic("RefreshImage",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display),f=function(b){a.Image.prototype.refreshImage.call(e,b,d.argv[1])};
e?c instanceof Blob?Fitsy.handleFITSFile(c,Fitsy.options,f):a.Image.prototype.refreshImage.apply(e,d.argv):c instanceof Blob&&a.Load.apply(null,arguments)});
a.mkPublic("GetLoadStatus",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);
return d?!b.argv[0]||d.oid===b.argv[0]?d.status.load:"other":"none"});
a.mkPublic("OpenFileMenu",function(a){$("#openLocalFile-"+a.id).click()});
a.mkPublic("NewFitsImage",function(c,b){var d;
b&&b.onload&&(d=b.onload);
a.checkNew(new a.Image(c,b,d))});
a.mkPublic("GetImage",function(c){var b;
c&&"string"!==typeof c&&(b=a.parsePublicArgs(arguments),c=b.display);
return a.getImage(c)});
a.mkPublic("GetImageData",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display),e=null;
if(d){if(b.argv[0])if("array"===b.argv[0])e=Array.prototype.slice.call(d.raw.data);
else if("base64"===b.argv[0]){for(var e="",f=new Uint8Array(d.raw.data.buffer),g=f.byteLength,b=0;
b<g;
b++)e+=String.fromCharCode(f[b]);
e=window.btoa(e)}else b.argv[0]&&"false"!==b.argv[0]&&(e=d.raw.data);
return{id:d.id,file:d.file,fits:d.fitsFile||"",source:d.source,imtab:d.imtab,width:d.raw.width,height:d.raw.height,bitpix:d.raw.bitpix,header:d.raw.header,data:e}}});
a.mkPublic("LoadAuxFile",function(c,b){var d=a.parsePublicArgs(arguments);
(d=a.getImage(d.display))?d.loadAuxFile(c,b):a.error("could not find image for aux file: "+c)});
a.mkPublic("SubmitAnalysis",function(c,b,d){var e,f,g;
e=a.lightOpts[a.LIGHTWIN];
var h=a.parsePublicArgs(arguments);
b?e=a.lookupDisplay(h.display).id:(e=$(c).closest(e.top),b=e.data("aname"),e=e.data("dispid"));
b?e&&(f=a.getImage(e)):g="internal error: could not find analysis task name";
if(f){e=$(c).closest("form");
try{h=e.serializeArray()}catch(j){h=null}f.runAnalysis(b,h,d)}else g="internal error: could not find image";
g&&a.error(g);
return!1});
a.mkPublic("Send",function(c,b,d){a.helper.connected?a.helper.send(c,b,d):a.error("no helper available")});
a.mkPublic("EventToDisplayPos",function(c){return a.eventToDisplayPos(c)});
a.mkPublic("PixToWCS",function(c,b){var d,e,f=1;
d=a.parsePublicArgs(arguments);
var g=a.getImage(d.display);
if(g&&0<g.wcs)return d=a.pix2wcs(g.wcs,c-1,b-1).trim(),e=d.split(/ +/),"sexagesimal"===g.params.wcsunits&&("galactic"!==g.params.wcssys&&"ecliptic"!==g.params.wcssys)&&(f=15),{ra:a.saostrtod(e[0])*f,dec:a.saostrtod(e[1]),sys:e[2],str:d}});
a.Pix2WCS=a.PixToWCS;
a.mkPublic("WCSToPix",function(c,b){var d,e,f;
e=a.parsePublicArgs(arguments);
return(e=a.getImage(e.display))&&0<e.wcs?(d=a.wcs2pix(e.wcs,c,b).trim().split(/ +/),e=parseFloat(d[0])+1,f=parseFloat(d[1])+1,d=sprintf("%f %f",e,f),{x:e,y:f,str:d}):null});
a.WCS2Pix=a.WCSToPix;
a.mkPublic("DisplayHelp",function(c){var b,d;
c&&((d=a.helpOpts[c])?(b=d.title+"_"+a.uniqueID(),c=a.InstallDir(d.type+"/"+d.url),a.lightWin(b,"iframe",c,d.title,"width=830px,height=400px,center=1,resize=1,scrolling=1")):(b=c+"_"+a.uniqueID(),d=c.split("/").reverse()[0],a.lightWin(b,"iframe",c,d,"width=830px,height=400px,center=1,resize=1,scrolling=1")))});
a.mkPublic("NewShapeLayer",function(c,b){var d=a.parsePublicArgs(arguments);
return(d=a.getImage(d.display))?d.display.newShapeLayer(c,b):null});
a.mkPublic("AddRegions",function(c,b){var d=a.parsePublicArgs(arguments);
return(d=a.getImage(d.display))?d.addShapes("regions",c,b):null});
a.mkPublic("RemoveRegions",function(c){var b=a.parsePublicArgs(arguments);
return(b=a.getImage(b.display))?(b.removeShapes("regions",c),b.clearMessage("regions"),"OK"):null});
a.mkPublic("GetRegions",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);
return d?(b.argv.unshift("regions"),d.getShapes.apply(d,b.argv)):null});
a.mkPublic("ChangeRegions",function(c,b){var d=a.parsePublicArgs(arguments);
(d=a.getImage(d.display))&&d.changeShapes("regions",c,b);
return null});
a.mkPublic("InstallDir",function(c){return a.INSTALLDIR+c});
a.mkPublic("AddDivs",function(){var c,b=a.parsePublicArgs(arguments);
for(c=0;
c<b.argv.length;
c++)a.checkNew(new a.Display(b.argv[c]));
a.instantiatePlugins()});
return a}(JS9);
$(document).ready(function(){JS9.init()});

